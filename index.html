<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Mipc Computadores</title>
	<style>
		:root{
			--bg:#0f1720; --panel:#0f2430; --accent:#c7ff00; --muted:#9aa5b1; --card:#0b1720;
		}
		body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#e6eef3;}
		.app{display:flex;min-height:100vh}
		.sidebar{width:240px;background:linear-gradient(180deg,#07121a,#0b1a22);padding:18px;box-shadow:2px 0 8px rgba(0,0,0,.4)}
		.brand{font-weight:700;color:var(--accent);margin-bottom:18px}
		.menu{list-style:none;padding:0;margin:0}
		.menu li{padding:10px 8px;border-radius:8px;color:var(--muted);cursor:pointer;margin-bottom:6px}
		.menu li.active{background:rgba(199,255,0,.08);color:var(--accent)}
		.main{flex:1;padding:22px}
		.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
		.card{background:linear-gradient(180deg, #071722, #06121a);padding:14px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.4)}
		.controls{display:flex;gap:8px;align-items:center}
		button.btn{background:var(--accent);color:#07121a;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
		table{width:100%;border-collapse:collapse;margin-top:12px;color:#dfeef2}
		th,td{padding:8px 10px;text-align:left;border-bottom:1px solid rgba(255,255,255,.03);font-size:14px}
		.actions button{margin-right:6px;padding:6px;border-radius:6px;border:0;cursor:pointer}
		.btn-edit{background:#3bb4ff;color:#05121a}
		.btn-delete{background:#ff5b6b;color:#fff}
		.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,8,.6)}
		.modal.show{display:flex}
		.modal .panel{width:640px;background:#071b22;padding:18px;border-radius:8px}
		.form-row{display:flex;gap:8px;margin-bottom:8px}
		.form-row input, .form-row textarea, select{flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,.06);background:#051417;color:#eaf6f3}
		.footer-note{margin-top:12px;color:var(--muted);font-size:13px}
		.small{font-size:13px;color:var(--muted)}

		/* estilos para galer√≠a de im√°genes */
		.image-preview-container{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
		.image-preview{position:relative;width:100px;height:100px;border-radius:6px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
		.image-preview img{width:100%;height:100%;object-fit:cover}
		.image-preview .remove-img{position:absolute;top:2px;right:2px;background:#ff5b6b;color:#fff;border:0;border-radius:4px;padding:2px 6px;cursor:pointer;font-size:11px}
		.image-preview .remove-img:hover{background:#ff3b4b}

		/* nuevo: estilos para badges de estado */
		.status-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:12px;color:#06121a}
		.status-ingresado{background:#c7ff00}
		.status-en_reparacion{background:#3bb4ff;color:#fff}
		.status-espera_entrega{background:#ffcc33;color:#07121a}
		.status-entregado{background:#7af0a5;color:#07121a}

		/* nuevo: estilos para badges de estado de pago */
		.payment-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:600}
		.payment-paid{background:#7af0a5;color:#07121a}
		.payment-unpaid{background:#ff5b6b;color:#fff}
		.btn-toggle-payment{background:#ffa726;color:#07121a;font-size:12px;padding:6px 10px}

		/* peque√±o ajuste: botones dentro de tablas tambi√©n usan .btn para aspecto */
		button.btn{font-size:13px;line-height:1;display:inline-block}

		/* modal historial */
		.history-list{max-height:320px;overflow:auto;padding:8px;border-radius:6px;background:#031419;color:#dff0ea}

		@media(max-width:800px){.sidebar{display:none}.modal .panel{width:95%}}
	</style>
</head>
<body>
	<div class="app">
		<aside class="sidebar card">
			<div class="brand">Mipc Computadores</div>
			<ul class="menu">
				<li class="active" data-view="orders">√ìrdenes</li>
				<li data-view="clients">Clientes</li>
				<li data-view="finance">Finanzas</li> <!-- nueva pesta√±a -->
				<li data-view="settings">Configuraci√≥n</li>
			</ul>
			<div style="margin-top:20px" class="small">Guardado en local (localStorage). Puedes exportar/importar desde Configuraci√≥n.</div>
		</aside>

		<main class="main">
			<div class="header">
				<h2 id="view-title">√ìrdenes</h2>
				<div class="controls">
					<button class="btn" id="btn-add-order">+ Nueva orden</button>
					<button class="btn" id="btn-add-client" style="display:none;background:#3bb4ff;color:#04121a">+ Nuevo cliente</button>
				</div>
			</div>

			<section id="orders-section" class="card">
				<div class="small">
					Filtrar:
					<input id="filter-input" placeholder="buscar por cliente, serie o modelo" style="margin-left:8px;padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
					<!-- nuevo: filtro por estado -->
					<select id="status-filter" style="margin-left:8px;padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
						<option value="">Todos los estados</option>
						<option value="ingresado">Ingresado</option>
						<option value="en_reparacion">En reparaci√≥n</option>
						<option value="espera_entrega">En espera de entrega</option>
						<option value="entregado">Entregado</option>
					</select>
					<!-- nuevo: filtro por estado de pago -->
					<select id="payment-filter" style="margin-left:8px;padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
						<option value="">Todos (pagos)</option>
						<option value="paid">Pagadas</option>
						<option value="unpaid">No pagadas</option>
					</select>
				</div>

				<table id="orders-table" aria-label="√ìrdenes">
					<thead>
						<tr>
							<th>ID</th><th>Cliente</th><th>Marca</th><th>Modelo</th><th>Serie</th><th>Accesorios</th><th>Falla</th>
							<th>Estado</th><th>Precio</th><th>Pago</th><th>Im√°genes</th><th>T√©cnico</th><th>Fecha</th><th>Acciones</th>
						</tr>
					</thead>
					<tbody>
						<!-- filas generadas por JS -->
					</tbody>
				</table>
				<div class="footer-note" id="orders-count"></div>
			</section>

			<section id="clients-section" class="card" style="display:none;margin-top:12px">
				<h3>Clientes</h3>
				<button class="btn" id="btn-new-client-inline" style="margin-bottom:8px">+ Nuevo cliente</button>
				<table id="clients-table">
					<thead><tr><th>ID</th><th>Nombre</th><th>C√©dula</th><th>Tel√©fono</th><th>Email</th><th>Acciones</th></tr></thead>
					<tbody></tbody>
				</table>
			</section>

			<!-- Nueva secci√≥n: Finanzas -->
			<section id="finance-section" class="card" style="display:none;margin-top:12px">
				<h3>Finanzas</h3>
				<!-- Panel m√©tricas -->
				<div id="finance-metrics" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
					<!-- contenido poblado por JS -->
				</div>
				<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
					<button class="btn" id="btn-new-transaction">+ Nueva transacci√≥n</button>
					<div id="finance-summary" class="small" style="margin-left:12px">Cargando...</div>
					<!-- filtros: tipo y categor√≠a -->
					<select id="type-filter" style="margin-left:12px;padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
						<option value="">Todos</option>
						<option value="income">Ingresos</option>
						<option value="expense">Gastos</option>
					</select>
					<select id="category-filter" style="margin-left:8px;padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
						<option value="">Todas las categor√≠as</option>
						<!-- opciones pobladas por JS -->
					</select>
				</div>
				<!-- Formulario inline para nueva transacci√≥n -->
				<form id="form-transaction" style="display:block;margin-bottom:8px;gap:8px">
					<div class="form-row">
						<select name="type" required>
							<option value="income">Ingreso</option>
							<option value="expense">Gasto</option>
						</select>
						<input name="amount" type="number" step="0.01" placeholder="Monto" required>
					</div>
					<div class="form-row">
						<select name="category" id="tx-category" required>
							<!-- opciones pobladas por JS -->
						</select>
						<input name="date" type="date" value="">
					</div>
					<div class="form-row">
						<input name="notes" placeholder="Notas" style="flex:2">
						<button class="btn" type="submit">Guardar</button>
					</div>
				</form>

				<table id="transactions-table">
					<thead><tr><th>ID</th><th>Tipo</th><th>Monto</th><th>Categor√≠a</th><th>Fecha</th><th>Notas</th><th>Acciones</th></tr></thead>
					<tbody></tbody>
				</table>
			</section>

			<section id="settings-section" class="card" style="display:none;margin-top:12px">
				<h3>Configuraci√≥n</h3>
				<button class="btn" id="export-data">Exportar datos (.json)</button>
				<button class="btn" id="import-data" style="background:#3bb4ff;color:#04121a">Importar</button>
				<!-- nuevo: exportar PDF de √≥rdenes -->
				<button class="btn" id="export-pdf" style="margin-left:8px;background:#7af0a5;color:#04121a">Exportar PDF (√ìrdenes)</button>
				<input type="file" id="import-file" accept="application/json" style="display:none">
				<div class="footer-note" style="margin-top:12px">Equipos guardados en hoja de vida por n√∫mero de serie.</div>
			</section>
		</main>
	</div>

	<!-- Modal: agregar/editar orden -->
	<div class="modal" id="modal-order">
		<div class="panel">
			<h3 id="modal-order-title">Nueva orden</h3>
			<form id="form-order">
				<div class="form-row">
					<select name="clientId" required>
						<option value="">-- Seleccionar cliente --</option>
					</select>
					<button type="button" class="btn" id="btn-order-new-client" style="background:#64707a">Nuevo cliente</button>
				</div>

				<!-- nuevo: selector de estado -->
				<div class="form-row">
					<select name="status" required>
						<option value="ingresado">Ingresado</option>
						<option value="en_reparacion">En reparaci√≥n</option>
						<option value="espera_entrega">En espera de entrega</option>
						<option value="entregado">Entregado</option>
					</select>
					<!-- espacio para futuro -->
					<input name="brand" placeholder="Marca" required>
				</div>

				<div class="form-row">
					<input name="serial" placeholder="N√∫mero de serie (√∫nico)" required>
					<input name="model" placeholder="Modelo">
				</div>
				<div class="form-row">
					<input name="accessories" placeholder="Accesorios (ej: cargador, funda)">
					<textarea name="failure" placeholder="Falla reportada" rows="1" required style="flex:2"></textarea>
				</div>

				<div class="form-row">
					<input name="technician" placeholder="T√©cnico asignado">
					<input name="price" type="number" step="0.01" placeholder="Precio" style="flex:1">
					<!-- nuevo: selector de estado de pago -->
					<select name="paid" style="flex:1">
						<option value="false">No pagado</option>
						<option value="true">Pagado</option>
					</select>
				</div>

				<div class="form-row">
					<input name="notes" placeholder="Notas internas" style="flex:1">
				</div>

				<!-- nuevo: campo para im√°genes -->
				<div class="form-row" style="flex-direction:column;align-items:flex-start">
					<label style="color:var(--muted);font-size:13px;margin-bottom:4px">
						Im√°genes del equipo: 
						<span id="image-count" style="color:var(--accent);font-weight:600">(0 im√°genes)</span>
					</label>
					<input type="file" id="order-images" accept="image/*" multiple style="padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
					<div id="image-preview-container" class="image-preview-container"></div>
				</div>

				<div style="display:flex;gap:8px;justify-content:flex-end">
					<button type="button" class="btn" id="btn-close-order" style="background:#64707a">Cancelar</button>
					<button type="submit" class="btn">Guardar orden</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Modal: cliente -->
	<div class="modal" id="modal-client">
		<div class="panel">
			<h3 id="modal-client-title">Nuevo cliente</h3>
			<form id="form-client">
				<!-- cambiado: ahora se pide la c√©dula -->
				<div class="form-row">
					<input name="name" placeholder="Nombre" required>
					<input name="cedula" placeholder="C√©dula" required>
				</div>
				<div class="form-row">
					<input name="phone" placeholder="Tel√©fono">
					<input name="email" placeholder="Email">
				</div>
				<div class="form-row">
					<input name="address" placeholder="Direcci√≥n">
				</div>
				<div style="display:flex;gap:8px;justify-content:flex-end">
					<button type="button" class="btn" id="btn-close-client" style="background:#64707a">Cancelar</button>
					<button type="submit" class="btn" style="background:#3bb4ff;color:#04121a">Guardar</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Modal: equipo / hoja de vida -->
	<div class="modal" id="modal-equipment">
		<div class="panel">
			<h3 id="modal-equipment-title">Hoja de vida - Equipo</h3>
			<div class="history-list" id="equipment-history"></div>
			<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
				<button type="button" class="btn" id="btn-close-equipment" style="background:#64707a">Cerrar</button>
			</div>
		</div>
	</div>

	<!-- incluir jsPDF desde CDN -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

	<script>
		// NUEVO: URL del API
		const API_URL = "https://pregnancy-essentially-perspectives-chapters.trycloudflare.com/api";


		// funciones reutilizables para comunicarse con el backend
		async function loadTable(table) {
			try {
				const res = await fetch(`${API_URL}/${table}`);
				if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
				return await res.json();
			} catch (err) {
				console.error("Error al cargar datos:", err);
				return [];
			}
		}

		async function saveTable(table, data) {
			try {
				await fetch(`${API_URL}/${table}`, {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(data)
				});
			} catch (err) {
				console.error("Error al guardar datos:", err);
			}
		}

		// Storage helpers (ahora as√≠ncronos y delegan a loadTable/saveTable)
		async function loadOrders(){ return await loadTable('orders'); }
		async function saveOrders(list){ await saveTable('orders', list); }
		async function loadClients(){ return await loadTable('clients'); }
		async function saveClients(list){ await saveTable('clients', list); }
		async function loadEquipments(){ return await loadTable('equipments'); }
		async function saveEquipments(list){ await saveTable('equipments', list); }
		async function loadTransactions(){ return await loadTable('transactions'); }
		async function saveTransactions(list){ await saveTable('transactions', list); }

		// Categor√≠as predefinidas para Finanzas
		const FINANCE_CATEGORIES = ['Servicios','Repuestos','Ventas','Nomina','Otros'];

		// nuevos: estados v√°lidos (clave -> etiqueta)
		const ORDER_STATUSES = {
			ingresado: 'Ingresado',
			en_reparacion: 'En reparaci√≥n',
			espera_entrega: 'En espera de entrega',
			entregado: 'Entregado'
		};

		// util
		const $ = sel => document.querySelector(sel);
		const $$ = sel => Array.from(document.querySelectorAll(sel));

		// estado
		let editingOrderId = null;
		let editingClientId = null;

		// init
		document.addEventListener('DOMContentLoaded', async ()=> {
			bindUI();
			renderView('orders');
			await renderOrders();
			await renderClients();
			populateFinanceCategorySelects(); // rellenar selects de categor√≠a
			await renderFinance(); // inicializar finanzas (despu√©s de poblar categor√≠as)
		});

		function bindUI(){
			// menu
			$$('.menu li').forEach(li=>{
				li.addEventListener('click', e=>{
					$$('.menu li').forEach(x=>x.classList.remove('active'));
					li.classList.add('active');
					renderView(li.dataset.view);
				});
			});

			$('#btn-add-order').addEventListener('click', ()=> openOrderModal());
			$('#btn-order-new-client').addEventListener('click', ()=> openClientModal());
			$('#btn-new-client-inline').addEventListener('click', ()=> openClientModal());
			$('#btn-add-client').addEventListener('click', ()=> openClientModal());

			$('#btn-close-order').addEventListener('click', ()=> closeModal('#modal-order'));
			$('#btn-close-client').addEventListener('click', ()=> closeModal('#modal-client'));
			$('#btn-close-equipment').addEventListener('click', ()=> closeModal('#modal-equipment'));

			$('#form-order').addEventListener('submit', async (e)=> await saveOrderFromForm(e));
			$('#form-client').addEventListener('submit', async (e)=> await saveClientFromForm(e));

			// nuevo: manejo de im√°genes
			$('#order-images').addEventListener('change', handleImageUpload);

			$('#filter-input').addEventListener('input', async ()=> await renderOrders());
			$('#status-filter').addEventListener('change', async ()=> await renderOrders());
			$('#payment-filter').addEventListener('change', async ()=> await renderOrders()); // nuevo: filtro de pago

			$('#export-data').addEventListener('click', async ()=> await exportData());
			$('#import-data').addEventListener('click', ()=> $('#import-file').click());
			$('#import-file').addEventListener('change', async (e)=> await importDataFile(e));
			// binding para exportar PDF
			const pdfBtn = $('#export-pdf');
			if(pdfBtn) pdfBtn.addEventListener('click', async ()=> await exportOrdersPDF());

			// Finanzas: bindings
			const txBtn = $('#btn-new-transaction');
			if(txBtn) txBtn.addEventListener('click', ()=> {
				const form = $('#form-transaction');
				form.reset();
				// fecha por defecto hoy
				const d = new Date().toISOString().slice(0,10);
				form.querySelector('input[name="date"]').value = d;
				// seleccionar primera categor√≠a por defecto si existe
				const catSel = form.querySelector('select[name="category"]');
				if(catSel && catSel.options.length>0) catSel.selectedIndex = 0;
				form.querySelector('input[name="amount"]').focus();
			});
			const txForm = $('#form-transaction');
			if(txForm) txForm.addEventListener('submit', async (e)=> await saveTransactionFromForm(e));

			// filtros: recargar render cuando cambian
			const typeFilter = $('#type-filter');
			if(typeFilter) typeFilter.addEventListener('change', async ()=> await renderFinance());
			const catFilter = $('#category-filter');
			if(catFilter) catFilter.addEventListener('change', async ()=> await renderFinance());
		}

		async function renderView(view){
			$('#view-title').textContent = view === 'orders' ? '√ìrdenes' : view === 'clients' ? 'Clientes' : view === 'finance' ? 'Finanzas' : 'Configuraci√≥n';
			$('#orders-section').style.display = view === 'orders' ? 'block' : 'none';
			$('#clients-section').style.display = view === 'clients' ? 'block' : 'none';
			$('#finance-section').style.display = view === 'finance' ? 'block' : 'none';
			$('#settings-section').style.display = view === 'settings' ? 'block' : 'none';
			$('#btn-add-client').style.display = view === 'clients' ? 'inline-block' : 'none';
		}

		// Render √≥rdenes (ahora as√≠ncrono)
		async function renderOrders(){
			const tbody = $('#orders-table tbody');
			const filter = $('#filter-input').value.toLowerCase().trim();
			const statusFilter = $('#status-filter').value;
			const paymentFilter = $('#payment-filter').value; // nuevo
			const all = await loadOrders();
			const items = all.filter(o=>{
				if(statusFilter && (o.status||'ingresado') !== statusFilter) return false;
				// nuevo: filtro de pago
				if(paymentFilter === 'paid' && !o.paid) return false;
				if(paymentFilter === 'unpaid' && o.paid) return false;
				if(!filter) return true;
				// findClientById es as√≠ncrona, pero aqu√≠ ya tenemos clientes cargados en memoria si queremos rendimiento.
				// Para simplicidad hacemos una b√∫squeda s√≠ncrona en clientes cargados (cargamos la lista).
				const client = (async ()=> { const cl = await loadClients(); return cl.find(c=>c.id==o.clientId) || {}; })();
				// como client es Promise, mejor cargar clientes antes
			});
			// Mejor enfoque: cargar clientes antes de filtrar
			const clients = await loadClients();
			const filtered = all.filter(o=>{
				if(statusFilter && (o.status||'ingresado') !== statusFilter) return false;
				if(paymentFilter === 'paid' && !o.paid) return false;
				if(paymentFilter === 'unpaid' && o.paid) return false;
				if(!filter) return true;
				const client = clients.find(c=>c.id==o.clientId) || {};
				return [client.name, o.brand, o.model, o.serial, o.accessories, o.failure, ORDER_STATUSES[o.status]||''].join(' ').toLowerCase().includes(filter);
			});
			tbody.innerHTML = '';
			filtered.forEach(o=>{
				const client = clients.find(c=>c.id==o.clientId) || {name:'--'};
				const statusKey = o.status || 'ingresado';
				const statusLabel = ORDER_STATUSES[statusKey] || statusKey;
				const statusClass = `status-${statusKey}`;
				const imageCount = (o.images && o.images.length) ? o.images.length : 0;
				const priceDisplay = o.price ? formatCurrency(Number(o.price)) : '--';
				// nuevo: estado de pago
				const isPaid = o.paid === true;
				const paymentBadge = isPaid 
					? '<span class="payment-badge payment-paid">Pagado</span>' 
					: '<span class="payment-badge payment-unpaid">No pagado</span>';
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td>${o.id}</td>
					<td>${escapeHtml(client.name)}</td>
					<td>${escapeHtml(o.brand||'')}</td>
					<td>${escapeHtml(o.model||'')}</td>
					<td><button type="button" class="btn btn-view-eq" data-serial="${escapeHtml(o.serial||'')}">${escapeHtml(o.serial||'')}</button></td>
					<td>${escapeHtml(o.accessories||'')}</td>
					<td>${escapeHtml(o.failure||'')}</td>
					<td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
					<td>${priceDisplay}</td>
					<td>${paymentBadge}</td>
					<td style="text-align:center">${imageCount}</td>
					<td>${escapeHtml(o.technician||'')}</td>
					<td>${new Date(o.date).toLocaleString()}</td>
					<td class="actions">
						<select class="inline-status" data-id="${o.id}">
							<option value="ingresado"${statusKey==='ingresado'?' selected':''}>Ingresado</option>
							<option value="en_reparacion"${statusKey==='en_reparacion'?' selected':''}>En reparaci√≥n</option>
							<option value="espera_entrega"${statusKey==='espera_entrega'?' selected':''}>En espera de entrega</option>
							<option value="entregado"${statusKey==='entregado'?' selected':''}>Entregado</option>
						</select>
						<button class="btn btn-toggle-payment" data-id="${o.id}" title="Cambiar estado de pago">${isPaid ? 'üí∞ Pagado' : 'üí≥ Marcar pagado'}</button>
						<button class="btn btn-edit" data-id="${o.id}">Editar</button>
						<button class="btn btn-delete" data-id="${o.id}">Eliminar</button>
						<button class="btn" style="background:#071a2a;color:#7af0a5" data-id="${o.id}" class="btn-pdf">PDF</button>
						<button class="btn btn-whatsapp" data-id="${o.id}" style="background:#25D366;color:#06121a">WhatsApp</button>
					</td>
				`;
				tbody.appendChild(tr);
			});

			// acciones
			$$('.btn-edit').forEach(b=>b.onclick = ()=> openOrderModal(b.dataset.id));
			$$('.btn-delete').forEach(b=>b.onclick = async ()=> { if(confirm('Eliminar orden?')) await deleteOrder(b.dataset.id) });
			$$('select.inline-status').forEach(s=>{
				s.onchange = async ()=> await updateOrderStatus(s.dataset.id, s.value);
			});
			// nuevo: toggle de pago
			$$('.btn-toggle-payment').forEach(b => b.onclick = async ()=> await toggleOrderPayment(b.dataset.id));

			// bot√≥n PDF por orden
			$$('button[data-id]').filter(b => b.classList.contains('btn') && b.textContent === 'PDF')
				.forEach(b => b.onclick = ()=> exportOrderPDF(b.dataset.id));

			// bot√≥n WhatsApp por orden
			$$('.btn-whatsapp').forEach(b => b.onclick = ()=> openWhatsApp(b.dataset.id));

			// abrir hoja de vida
			$$('.btn-view-eq').forEach(b=> b.onclick = ()=> {
				const serial = b.dataset.serial;
				if(!serial) return alert('Serie inv√°lida');
				openEquipmentModal(serial);
			});

			$('#orders-count').textContent = `Mostrando ${filtered.length} registros`;
			// actualizar m√©tricas cuando se renderizan √≥rdenes
			await computeMetrics();
		}

		// eliminar orden (ahora as√≠ncrono)
		async function deleteOrder(id){
			const list = (await loadOrders()).filter(x=>x.id!=id);
			await saveOrders(list);
			await renderOrders();
			await renderFinance();
			await computeMetrics();
		}

		// Generar PDF para una sola orden (sincr√≥nico en su uso pero puede ser async)
		async function exportOrderPDF(id){
			const orders = await loadOrders();
			const order = orders.find(o=>o.id==id);
			if(!order) return alert('Orden no encontrada');
			const client = (await loadClients()).find(c=>c.id==order.clientId) || {name:'--', phone:'', email:''};
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({unit:'pt', format:'letter'});
			const margin = 40;
			let y = margin;
			doc.setFontSize(16);
			doc.text('Orden de servicio - Mipc Computadores', margin, y);
			y += 24;
			doc.setFontSize(11);

			const lines = [
				`ID: ${order.id}`,
				`Fecha: ${order.date ? new Date(order.date).toLocaleString() : ''}`,
				`Estado: ${ORDER_STATUSES[order.status||'ingresado'] || order.status}`,
				`Pago: ${order.paid ? 'Pagado' : 'No pagado'}`,
				'',
				'Cliente:',
				`  Nombre: ${client.name}`,
				`  Tel√©fono: ${client.phone||''}`,
				`  Email: ${client.email||''}`,
				'',
				'Equipo:',
				`  Marca: ${order.brand||''}`,
				`  Modelo: ${order.model||''}`,
				`  Serie: ${order.serial||''}`,
				`  Accesorios: ${order.accessories||''}`,
				'',
				`Falla reportada: ${order.failure||''}`,
				`T√©cnico: ${order.technician||''}`,
				`Precio: ${order.price ? formatCurrency(Number(order.price)) : 'No especificado'}`,
				`Im√°genes adjuntas: ${(order.images && order.images.length) || 0}`,
				`Notas: ${order.notes||''}`
			];

			const pageHeight = doc.internal.pageSize.height;
			const lineHeight = 14;
			lines.forEach(line=>{
				if(y + lineHeight > pageHeight - margin){
					doc.addPage();
					y = margin;
				}
				doc.text(wrapText(line, 90), margin, y);
				y += lineHeight * (Array.isArray(wrapText(line,90)) ? wrapText(line,90).length : 1);
			});

			doc.save(`orden_${order.id}.pdf`);

			function wrapText(text, maxChars){
				if(!text) return '';
				if(text.length <= maxChars) return text;
				const parts = [];
				let start = 0;
				while(start < text.length){
					parts.push(text.slice(start, start+maxChars));
					start += maxChars;
				}
				return parts;
			}
		}

		async function openOrderModal(id){
			editingOrderId = id || null;
			const modal = $('#modal-order');
			$('#modal-order-title').textContent = id ? 'Editar orden' : 'Nueva orden';
			const form = $('#form-order');
			form.reset();
			await populateClientSelect();
			// limpiar im√°genes previas
			currentOrderImages = [];
			$('#image-preview-container').innerHTML = '';
			$('#order-images').value = '';

			if(id){
				const item = (await loadOrders()).find(x=>x.id==id);
				if(item){
					form.clientId.value = item.clientId || '';
					form.brand.value = item.brand || '';
					form.serial.value = item.serial || '';
					form.model.value = item.model || '';
					form.accessories.value = item.accessories || '';
					form.failure.value = item.failure || '';
					form.technician.value = item.technician || '';
					form.price.value = item.price || '';
					form.notes.value = item.notes || '';
					form.status.value = item.status || 'ingresado';
					form.paid.value = item.paid ? 'true' : 'false';
					// cargar im√°genes existentes
					if(item.images && Array.isArray(item.images)){
						currentOrderImages = [...item.images];
						renderImagePreviews();
					}
				}
			}
			modal.classList.add('show');
			form.querySelector('select[name="clientId"]').focus();
		}
		function closeModal(sel){ document.querySelector(sel).classList.remove('show'); editingOrderId = null; editingClientId = null; }

		// nueva variable global para almacenar im√°genes temporalmente
		let currentOrderImages = [];

		// nueva funci√≥n: manejar carga de im√°genes
		function handleImageUpload(e){
			const files = Array.from(e.target.files);
			if(files.length === 0) return;
			
			files.forEach(file => {
				if(!file.type.startsWith('image/')) return;
				
				// limitar tama√±o (m√°x 2MB por imagen)
				if(file.size > 2 * 1024 * 1024){
					alert(`La imagen ${file.name} es muy grande. M√°ximo 2MB por imagen.`);
					return;
				}

				const reader = new FileReader();
				reader.onload = (ev) => {
					currentOrderImages.push({
						data: ev.target.result,
						name: file.name,
						date: new Date().toISOString()
					});
					renderImagePreviews();
				};
				reader.readAsDataURL(file);
			});
			
			// limpiar input para permitir seleccionar las mismas im√°genes nuevamente
			e.target.value = '';
		}

		// nueva funci√≥n: renderizar vista previa de im√°genes
		function renderImagePreviews(){
			const container = $('#image-preview-container');
			container.innerHTML = '';
			
			currentOrderImages.forEach((img, index) => {
				const div = document.createElement('div');
				div.className = 'image-preview';
				div.innerHTML = `
					<img src="${img.data}" alt="${escapeHtml(img.name)}">
					<button type="button" class="remove-img" data-index="${index}">‚úï</button>
				`;
				container.appendChild(div);
			});

			// actualizar contador de im√°genes
			const countEl = $('#image-count');
			if(countEl){
				const count = currentOrderImages.length;
				countEl.textContent = `(${count} ${count === 1 ? 'imagen' : 'im√°genes'})`;
			}

			// bind eliminar imagen
			$$('.remove-img').forEach(btn => {
				btn.onclick = () => {
					const index = parseInt(btn.dataset.index);
					currentOrderImages.splice(index, 1);
					renderImagePreviews();
				};
			});
		}

		async function saveOrderFromForm(e){
			e.preventDefault();
			const f = e.target;
			const list = await loadOrders();
			if(editingOrderId){
				const idx = list.findIndex(x=>x.id==editingOrderId);
				if(idx>-1){
					list[idx] = {
						...list[idx],
						clientId: f.clientId.value,
						brand: f.brand.value,
						serial: f.serial.value,
						model: f.model.value,
						accessories: f.accessories.value,
						failure: f.failure.value,
						technician: f.technician.value,
						price: f.price.value || null,
						notes: f.notes.value,
						status: f.status ? f.status.value || f.status : (list[idx].status || 'ingresado'),
						paid: f.paid.value === 'true',
						images: currentOrderImages
					};
					await upsertEquipmentFromOrder(list[idx]);
				}
			} else {
				const item = {
					id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
					clientId: f.clientId.value,
					brand: f.brand.value,
					serial: f.serial.value,
					model: f.model.value,
					accessories: f.accessories.value,
					failure: f.failure.value,
					technician: f.technician.value,
					price: f.price.value || null,
					notes: f.notes.value,
					status: f.status ? f.status.value || 'ingresado' : 'ingresado',
					paid: f.paid.value === 'true',
					date: new Date().toISOString(),
					images: currentOrderImages
				};
				list.unshift(item);
				await upsertEquipmentFromOrder(item);
			}
			await saveOrders(list);
			closeModal('#modal-order');
			await renderOrders();
		}

		// nueva funci√≥n: actualizar estado r√°pidamente
		async function updateOrderStatus(id, newStatus){
			const list = await loadOrders();
			const idx = list.findIndex(x=>x.id==id);
			if(idx===-1) return;
			list[idx].status = newStatus;
			await upsertEquipmentFromOrder({...list[idx], date: new Date().toISOString()});
			await saveOrders(list);
			await renderOrders();
		}

		// Clients (ahora as√≠ncrono)
		async function renderClients(){
			const tbody = $('#clients-table tbody');
			const items = await loadClients();
			tbody.innerHTML = '';
			items.forEach(c=>{
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td>${c.id}</td>
					<td>${escapeHtml(c.name)}</td>
					<td>${escapeHtml(c.cedula||'')}</td>
					<td>${escapeHtml(c.phone||'')}</td>
					<td>${escapeHtml(c.email||'')}</td>
					<td>
						<button class="btn btn-edit" data-id="${c.id}">Editar</button>
						<button class="btn btn-delete" data-id="${c.id}">Eliminar</button>
					</td>
				`;
				tbody.appendChild(tr);
			});
			$$('#clients-table .btn-edit').forEach(b=>b.onclick = ()=> openClientModal(b.dataset.id));
			$$('#clients-table .btn-delete').forEach(b=>b.onclick = async ()=> { if(confirm('Eliminar cliente?')) await deleteClient(b.dataset.id) });
			// actualizar m√©tricas al renderizar clientes
			await computeMetrics();
		}

		async function openClientModal(id){
			editingClientId = id || null;
			const modal = $('#modal-client');
			$('#modal-client-title').textContent = id ? 'Editar cliente' : 'Nuevo cliente';
			const form = $('#form-client');
			form.reset();
			if(id){
				const item = (await loadClients()).find(x=>x.id==id);
				if(item){
					form.name.value = item.name || '';
					form.cedula.value = item.cedula || '';
					form.phone.value = item.phone || '';
					form.email.value = item.email || '';
					form.address.value = item.address || '';
				}
			}
			modal.classList.add('show');
		}

		async function saveClientFromForm(e){
			e.preventDefault();
			const f = e.target;
			const list = await loadClients();
			let newClientId = null;
			if(editingClientId){
				const idx = list.findIndex(x=>x.id==editingClientId);
				if(idx>-1){
					list[idx] = {...list[idx],
						name:f.name.value,
						cedula: f.cedula.value,
						phone:f.phone.value,
						email:f.email.value,
						address:f.address.value
					};
				}
			} else {
				const item = {
					id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
					name:f.name.value,
					cedula: f.cedula.value,
					phone:f.phone.value,
					email:f.email.value,
					address:f.address.value
				};
				list.unshift(item);
				newClientId = item.id;
			}
			await saveClients(list);

			// repoblar select de clientes en el formulario de orden
			await populateClientSelect();

			// si creamos un cliente nuevo, seleccionarlo autom√°ticamente en el formulario de orden (si existe)
			if(newClientId){
				const orderSel = document.querySelector('#form-order select[name="clientId"]');
				if(orderSel){
					orderSel.value = newClientId;
					const modalOrder = document.querySelector('#modal-order');
					if(modalOrder && modalOrder.classList.contains('show')) orderSel.focus();
				}
			}

			closeModal('#modal-client');
			await renderClients();
		}

		async function deleteClient(id){
			const list = (await loadClients()).filter(x=>x.id!=id);
			await saveClients(list);
			await renderClients();
			// repoblar select de clientes
			await populateClientSelect();
		}

		// Helpers para clientes
		async function populateClientSelect(){
			const sel = document.querySelector('#form-order select[name="clientId"]');
			const clients = await loadClients();
			if(!sel) return;
			sel.innerHTML = '<option value="">-- Seleccionar cliente --</option>';
			clients.forEach(c => {
				const opt = document.createElement('option');
				opt.value = c.id; opt.textContent = c.name;
				sel.appendChild(opt);
			});
		}
		async function findClientById(id){ const clients = await loadClients(); return clients.find(c=>c.id==id); }

		// Equipments: hoja de vida por serial (as√≠ncrono)
		async function upsertEquipmentFromOrder(order){
			if(!order.serial) return;
			const list = await loadEquipments();
			let eq = list.find(e => e.serial && e.serial.toLowerCase() === order.serial.toLowerCase());
			const entry = {
				orderId: order.id,
				date: order.date || new Date().toISOString(),
				clientId: order.clientId,
				brand: order.brand,
				model: order.model,
				accessories: order.accessories,
				failure: order.failure,
				technician: order.technician,
				notes: order.notes,
				status: order.status || 'ingresado'
			};
			if(eq){
				eq.brand = order.brand || eq.brand;
				eq.model = order.model || eq.model;
				eq.clientId = order.clientId || eq.clientId;
				eq.history = eq.history || [];
				eq.history.unshift(entry);
			} else {
				eq = {
					id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
					serial: order.serial,
					brand: order.brand,
					model: order.model,
					clientId: order.clientId,
					history: [entry]
				};
				list.unshift(eq);
			}
			await saveEquipments(list);
		}

		// Export / Import (ahora usan el backend)
		async function exportData(){
			const data = { orders: await loadOrders(), clients: await loadClients(), equipments: await loadEquipments(), transactions: await loadTransactions(), exportedAt: new Date().toISOString() };
			const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url; a.download = 'mipc_data.json'; a.click();
			URL.revokeObjectURL(url);
		}
		async function importDataFile(e){
			const file = e.target.files[0];
			if(!file) return;
			const reader = new FileReader();
			reader.onload = async ev => {
				try {
					const data = JSON.parse(ev.target.result);
					if(Array.isArray(data.orders)) await saveOrders(data.orders);
					if(Array.isArray(data.clients)) await saveClients(data.clients);
					if(Array.isArray(data.equipments)) await saveEquipments(data.equipments);
					if(Array.isArray(data.transactions)) await saveTransactions(data.transactions);
					alert('Importaci√≥n completada');
					await renderOrders(); await renderClients();
					await renderFinance();
				} catch(err){
					alert('Archivo inv√°lido');
				}
			};
			reader.readAsText(file);
			e.target.value = '';
		}

		// Exportar √≥rdenes a PDF (usa jsPDF) - ahora async para obtener datos
		async function exportOrdersPDF(){
			const orders = await loadOrders();
			if(!orders || orders.length===0) return alert('No hay √≥rdenes para exportar.');
			const clients = await loadClients();
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({unit:'pt', format:'letter'});
			const margin = 40;
			let y = 40;
			const lineHeight = 14;
			const pageHeight = doc.internal.pageSize.height;
			doc.setFontSize(14);
			doc.text('√ìrdenes - Mipc Computadores', margin, y);
			y += 20;
			doc.setFontSize(10);

			const cols = ['ID','Cliente','Marca','Modelo','Serie','Estado','Pago','T√©cnico','Fecha'];
			const colWidths = [40,100,60,60,80,70,50,80,80];
			const startX = margin;

			function printRow(values){
				let x = startX;
				for(let i=0;i<values.length;i++){
					const txt = (values[i]===null||values[i]===undefined)?'':String(values[i]);
					doc.text(truncateText(txt, Math.floor(colWidths[i]/6)), x, y);
					x += colWidths[i];
				}
				y += lineHeight;
			}

			printRow(cols);
			doc.setLineWidth(0.5);
			doc.line(margin, y-8, pageHeight - margin, y-8);

			orders.forEach((o, idx)=>{
				const client = clients.find(c=>c.id==o.clientId) || {name:'--'};
				const statusLabel = ORDER_STATUSES[o.status || 'ingresado'] || (o.status||'');
				const paymentLabel = o.paid ? 'S√≠' : 'No';
				const row = [
					o.id,
					client.name,
					o.brand || '',
					o.model || '',
					o.serial || '',
					statusLabel,
					paymentLabel,
					o.technician || '',
					o.date ? new Date(o.date).toLocaleString() : ''
				];
				if(y + lineHeight > pageHeight - margin){
					doc.addPage();
					y = margin;
				}
				printRow(row);
			});

			doc.save('ordenes_mipc.pdf');

			function truncateText(str, maxChars){
				if(!str) return '';
				if(str.length <= maxChars) return str;
				return str.slice(0, maxChars-3) + '...';
			}
		}

		// helpers
		function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

		// Modal: ver hoja de vida del equipo
		async function openEquipmentModal(serial){
			const modal = $('#modal-equipment');
			$('#modal-equipment-title').textContent = `Hoja de vida - ${serial}`;
			const container = $('#equipment-history');
			container.innerHTML = '';
			const list = await loadEquipments();
			const eq = list.find(e => e.serial && e.serial.toLowerCase() === serial.toLowerCase());
			if(!eq){
				container.innerHTML = '<div class="history-item">No hay historial para este n√∫mero de serie.</div>';
			} else {
				eq.history = eq.history || [];
				eq.history.forEach(h=>{
					const client = (async ()=> { const c = await findClientById(h.clientId); return c || {name:'--'}; })();
					// para simplicidad mostramos cliente por id si existe (carga ya as√≠ncrona)
					const clientSync = (function(){ /* placeholder */ })();
					const div = document.createElement('div');
					div.className = 'history-item';
					div.innerHTML = `<strong>${new Date(h.date).toLocaleString()}</strong> ‚Äî ${escapeHtml(h.status||'')} ‚Äî ${escapeHtml(h.failure||'')}<br><span class="small">Cliente: ${escapeHtml(((findClientById(h.clientId)||{}).name)||'--')} ‚Äî T√©cnico: ${escapeHtml(h.technician||'')}</span>`;
					container.appendChild(div);
				});
			}
			modal.classList.add('show');
		}

		// Generar link de WhatsApp para una orden
		async function generateWhatsAppLink(order){
			const client = await findClientById(order.clientId) || {};
			let phone = client.phone || '';
			const normalized = normalizePhone(phone);
			if(!normalized){
				alert('Tel√©fono del cliente no disponible para enviar WhatsApp.');
				return null;
			}
			const name = client.name || 'cliente';
			const brand = order.brand || '';
			const model = order.model || '';
			const serial = order.serial || '';
			const technician = order.technician || '';
			const status = order.status || 'ingresado';
			const detailLink = `https://tuulapp.com/1/?i=${encodeURIComponent(order.id)}`;

			let msg = '';
			switch(status){
				case 'en_reparacion':
					msg = `Hola ${name}, te informamos que tu equipo (${brand} ${model}, S/N: ${serial}) est√° en reparaci√≥n. Nuestro t√©cnico ${technician || 'asignado'} est√° trabajando en la evaluaci√≥n y reparaci√≥n. Te avisaremos cuando haya novedades.`;
					break;
				case 'espera_entrega':
					msg = `Hola ${name}, tu equipo (${brand} ${model}, S/N: ${serial}) ya est√° listo y en espera de entrega en nuestro taller. Por favor pasa a recogerlo. Si necesitas coordinar la entrega, responde este mensaje.`;
					break;
				case 'entregado':
					msg = `Hola ${name}, confirmamos que tu equipo (${brand} ${model}, S/N: ${serial}) ha sido entregado. Muchas gracias por confiar en Mipc Computadores. Si tienes alguna inquietud, cont√°ctanos.`;
					break;
				case 'ingresado':
				default:
					msg = `Hola ${name}, tu equipo (${brand} ${model}, S/N: ${serial}) ha sido ingresado a nuestro taller. Puedes ver los detalles y seguimiento aqu√≠: ${detailLink}. Pronto te informaremos sobre el estado.`;
					break;
			}

			msg = `${msg} ‚Äî Mipc Computadores`;

			return `https://api.whatsapp.com/send?phone=${normalized}&text=${encodeURIComponent(msg)}&type=phone_number&app_absent=0`;
		}

		// Abrir WhatsApp para la orden (usa siempre el tel√©fono guardado en el cliente y prefijo 57)
		async function openWhatsApp(id){
			const order = (await loadOrders()).find(o=>o.id==id);
			if(!order) return alert('Orden no encontrada');
			const link = await generateWhatsAppLink(order);
			if(!link) return;
			window.open(link, '_blank');
		}

		// Normaliza tel√©fono
		function normalizePhone(phone){
			phone = (phone||'').replace(/\D/g,'');
			if(!phone) return null;
			// eliminar ceros iniciales
			phone = phone.replace(/^0+/, '');
			// si no empieza con 57, agregarlo
			if(!phone.startsWith('57')) phone = '57' + phone;
			return phone;
		}

		// Finanzas: renderizado de transacciones (as√≠ncrono)
		async function renderFinance(){
			const tbody = $('#transactions-table tbody');
			const items = await loadTransactions();
			tbody.innerHTML = '';
			let totalIncome = 0, totalExpense = 0;
			const typeFilter = ($('#type-filter') && $('#type-filter').value) || '';
			const categoryFilter = ($('#category-filter') && $('#category-filter').value) || '';
			const filtered = items.filter(t=>{
				if(typeFilter && t.type !== typeFilter) return false;
				if(categoryFilter && t.category !== categoryFilter) return false;
				return true;
			});
			filtered.forEach(t=>{
				if(t.type==='income') totalIncome += Number(t.amount||0);
				else totalExpense += Number(t.amount||0);
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td>${t.id}</td>
					<td>${t.type==='income'?'Ingreso':'Gasto'}</td>
					<td>${formatCurrency(Number(t.amount||0))}</td>
					<td>${escapeHtml(t.category||'')}</td>
					<td>${t.date || ''}</td>
					<td>${escapeHtml(t.notes||'')}</td>
					<td>
						<button class="btn btn-delete" data-id="${t.id}">Eliminar</button>
					</td>
				`;
				tbody.appendChild(tr);
			});
			$$('#transactions-table .btn-delete').forEach(b=> b.onclick = async ()=> { if(confirm('Eliminar transacci√≥n?')) await deleteTransaction(b.dataset.id) });
			const summary = $('#finance-summary');
			const balance = totalIncome - totalExpense;
			if(summary) summary.textContent = `Ingresos: ${formatCurrency(totalIncome)} ‚Äî Gastos: ${formatCurrency(totalExpense)} ‚Äî Saldo: ${formatCurrency(balance)}`;
			await computeMetrics();
		}

		async function saveTransactionFromForm(e){
			e.preventDefault();
			const f = e.target;
			const list = await loadTransactions();
			const item = {
				id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
				type: f.type.value,
				amount: Number(f.amount.value || 0),
				category: f.category.value,
				date: f.date.value || new Date().toISOString().slice(0,10),
				notes: f.notes.value
			};
			list.unshift(item);
			await saveTransactions(list);
			f.reset();
			await renderFinance();
		}

		async function deleteTransaction(id){
			const list = (await loadTransactions()).filter(x=>x.id!=id);
			await saveTransactions(list);
			await renderFinance();
		}

		function formatCurrency(v){
			try {
				return new Intl.NumberFormat('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:2 }).format(v);
			} catch(e){
				return (v||0).toFixed(2);
			}
		}

		// nuevas m√©tricas (async)
		async function computeMetrics(){
			const tx = await loadTransactions();
			const orders = await loadOrders();
			const clients = await loadClients();
			let income = 0, expense = 0;
			tx.forEach(t => {
				if(t.type === 'income') income += Number(t.amount||0);
				else expense += Number(t.amount||0);
			});
			const balance = income - expense;
			const txCount = tx.length;
			const avgTx = txCount ? ((income + expense) / txCount) : 0;
			const statusCounts = {};
			Object.keys(ORDER_STATUSES).forEach(k => statusCounts[k] = 0);
			let paidOrders = 0, unpaidOrders = 0;
			orders.forEach(o => {
				const s = o.status || 'ingresado';
				statusCounts[s] = (statusCounts[s]||0) + 1;
				if(o.paid) paidOrders++;
				else unpaidOrders++;
			});
			const container = document.getElementById('finance-metrics');
			if(!container) return;
			container.innerHTML = `
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:140px">
					<div class="small">Ingresos</div>
					<div style="font-weight:700">${formatCurrency(income)}</div>
				</div>
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:140px">
					<div class="small">Gastos</div>
					<div style="font-weight:700">${formatCurrency(expense)}</div>
				</div>
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:140px">
					<div class="small">Saldo</div>
					<div style="font-weight:700">${formatCurrency(balance)}</div>
				</div>
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:140px">
					<div class="small">Transacciones</div>
					<div style="font-weight:700">${txCount}</div>
					<div class="small">Promedio: ${formatCurrency(avgTx)}</div>
				</div>
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:180px">
					<div class="small">√ìrdenes</div>
					<div style="font-weight:700">${orders.length}</div>
					<div class="small">Clientes: ${clients.length}</div>
					<div class="small">Pagadas: ${paidOrders} / No pagadas: ${unpaidOrders}</div>
				</div>
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:220px">
					<div class="small">Desglose por estado (√≥rdenes)</div>
					<div style="font-weight:600;margin-top:6px">
						${Object.keys(ORDER_STATUSES).map(k => `${ORDER_STATUSES[k]}: ${statusCounts[k]||0}`).join(' ‚Äî ')}
					</div>
				</div>
			`;
		}

		// nueva funci√≥n: cambiar estado de pago (async)
		async function toggleOrderPayment(id){
			const list = await loadOrders();
			const idx = list.findIndex(x=>x.id==id);
			if(idx===-1) return;
			
			const order = list[idx];
			const wasPaid = order.paid;
			
			list[idx].paid = !wasPaid;
			await saveOrders(list);
			
			if(!wasPaid && list[idx].paid && order.price && Number(order.price) > 0){
				const client = (await loadClients()).find(c=>c.id==order.clientId) || {name:'Cliente'};
				const transactions = await loadTransactions();
				
				const transaction = {
					id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
					type: 'income',
					amount: Number(order.price),
					category: 'Servicios',
					date: new Date().toISOString().slice(0,10),
					notes: `Pago orden ${order.id} ‚Äî ${client.name}`,
					orderId: order.id
				};
				
				transactions.unshift(transaction);
				await saveTransactions(transactions);
			}
			
			if(wasPaid && !list[idx].paid){
				let transactions = await loadTransactions();
				const initialCount = transactions.length;
				transactions = transactions.filter(t => {
					const linkedByOrderId = t.orderId && t.orderId === order.id;
					const linkedByNotes = t.notes && t.notes.includes(`orden ${order.id}`);
					return !(linkedByOrderId || linkedByNotes);
				});
				
				if(transactions.length < initialCount){
					await saveTransactions(transactions);
					console.log(`Transacci√≥n eliminada para orden ${order.id}`);
				}
			}
			
			await renderOrders();
			await renderFinance();
			await computeMetrics();
		}
	</script>
</body>

</html>
