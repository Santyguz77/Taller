<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Mipc Computadores</title>
	<style>
		:root{
			--bg:#0f1720; --panel:#0f2430; --accent:#c7ff00; --muted:#9aa5b1; --card:#0b1720;
		}
		body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#e6eef3;}
		.app{display:flex;min-height:100vh}
		.sidebar{width:240px;background:linear-gradient(180deg,#07121a,#0b1a22);padding:18px;box-shadow:2px 0 8px rgba(0,0,0,.4)}
		.brand{font-weight:700;color:var(--accent);margin-bottom:18px}
		.menu{list-style:none;padding:0;margin:0}
		.menu li{padding:10px 8px;border-radius:8px;color:var(--muted);cursor:pointer;margin-bottom:6px}
		.menu li.active{background:rgba(199,255,0,.08);color:var(--accent)}
		.main{flex:1;padding:22px}
		.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
		.card{background:linear-gradient(180deg, #071722, #06121a);padding:14px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.4)}
		.controls{display:flex;gap:8px;align-items:center}
		button.btn{background:var(--accent);color:#07121a;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
		table{width:100%;border-collapse:collapse;margin-top:12px;color:#dfeef2}
		th,td{padding:8px 10px;text-align:left;border-bottom:1px solid rgba(255,255,255,.03);font-size:14px}
		.actions button{margin-right:6px;padding:6px;border-radius:6px;border:0;cursor:pointer}
		.btn-edit{background:#3bb4ff;color:#05121a}
		.btn-delete{background:#ff5b6b;color:#fff}
		.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,8,.6)}
		.modal.show{display:flex}
		.modal .panel{width:640px;background:#071b22;padding:18px;border-radius:8px}
		.form-row{display:flex;gap:8px;margin-bottom:8px}
		.form-row input, .form-row textarea, select{flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,.06);background:#051417;color:#eaf6f3}
		.footer-note{margin-top:12px;color:var(--muted);font-size:13px}
		.small{font-size:13px;color:var(--muted)}

		/* estilos para galería de imágenes */
		.image-preview-container{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
		.image-preview{position:relative;width:100px;height:100px;border-radius:6px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
		.image-preview img{width:100%;height:100%;object-fit:cover}
		.image-preview .remove-img{position:absolute;top:2px;right:2px;background:#ff5b6b;color:#fff;border:0;border-radius:4px;padding:2px 6px;cursor:pointer;font-size:11px}
		.image-preview .remove-img:hover{background:#ff3b4b}

		/* nuevo: estilos para badges de estado */
		.status-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:12px;color:#06121a}
		.status-ingresado{background:#c7ff00}
		.status-en_reparacion{background:#3bb4ff;color:#fff}
		.status-espera_entrega{background:#ffcc33;color:#07121a}
		.status-entregado{background:#7af0a5;color:#07121a}

		/* nuevo: estilos para badges de estado de pago */
		.payment-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:600}
		.payment-paid{background:#7af0a5;color:#07121a}
		.payment-unpaid{background:#ff5b6b;color:#fff}
		.btn-toggle-payment{background:#ffa726;color:#07121a;font-size:12px;padding:6px 10px}

		/* pequeño ajuste: botones dentro de tablas también usan .btn para aspecto */
		button.btn{font-size:13px;line-height:1;display:inline-block}

		/* modal historial */
		.history-list{max-height:320px;overflow:auto;padding:8px;border-radius:6px;background:#031419;color:#dff0ea}

		/* NUEVO: contenedor para scroll horizontal de tablas */
		.table-scroll {
			overflow-x: auto;
			-webkit-overflow-scrolling: touch;
			border-radius: 8px;
		}
		/* NUEVO: ancho mínimo para que la tabla pueda desplazarse en móvil */
		table {
			/* ...existing code... */
			min-width: 900px; /* asegura scroll horizontal en pantallas angostas */
		}

		/* NUEVO: filtros en línea que se adaptan en móvil */
		#orders-section .small.filters {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			align-items: center;
		}

		/* NUEVO: celda de acciones adaptable */
		td.actions {
			display: flex;
			flex-wrap: wrap;
			gap: 6px;
		}
		td.actions button,
		td.actions select {
			margin-right: 0; /* anula margen previo para usar gap */
			margin-bottom: 0;
		}

		/* NUEVO: mejoras modales en pantallas pequeñas/medianas */
		.modal .panel{
			/* ...existing code... */
			max-height: 90vh;
			overflow: auto;
		}

		/* NUEVO: mejoras generales responsivas */
		.header{
			/* ...existing code... */
			flex-wrap: wrap;
			align-items: flex-start;
			gap: 10px;
		}
		.controls{
			/* ...existing code... */
			flex-wrap: wrap;
		}

		/* NUEVO: media queries suaves */
		@media (max-width: 800px){
			/* Sidebar ya se oculta con tu regla existente */

			/* Cabecera y botones */
			.header{flex-direction: column;}
			button.btn{min-height: 40px}

			/* Formularios */
			.form-row{flex-direction: column}
			.form-row input, .form-row textarea, .form-row select{width:100%}

			/* Tabla más compacta */
			table{font-size: 12px}
			th,td{padding:6px 8px}

			/* Imágenes un poco más pequeñas */
			.image-preview{width:80px;height:80px}
		}

		@media (max-width: 480px){
			/* Tabla aún más compacta */
			table{font-size: 11px; min-width: 700px}
			th,td{padding:6px}

			/* Botones cómodos al tacto */
			button.btn{min-height:44px;font-size:14px}

			/* Vista previa imágenes en muy pequeño */
			.image-preview{width:64px;height:64px}
		}

		/* NUEVO: estilos mínimos para inventario */
		#inventory-section .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
		#inventory-section .controls input { padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2 }
		.badge-cat{display:inline-block;padding:2px 8px;border-radius:10px;background:rgba(255,255,255,.08);font-size:12px;color:#cfe6f3}

		/* NUEVO: estilos para facturas */
		#invoices-section .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
		.invoice-items-list { margin-top:12px; padding:10px; background:#031419; border-radius:6px }
		.invoice-item-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; padding:8px; background:#051820; border-radius:4px }
		.invoice-item-row input, .invoice-item-row select { flex:1; padding:6px; border-radius:4px; background:#062028; border:1px solid rgba(255,255,255,.04); color:#dfeef2 }
		.invoice-item-row .small { flex:1; color:var(--muted) }
		.invoice-total { text-align:right; font-size:16px; font-weight:700; color:var(--accent); margin-top:12px; padding:10px; background:#051820; border-radius:6px }
		.badge-status-paid { background:#7af0a5; color:#07121a; padding:4px 8px; border-radius:10px; font-size:12px; font-weight:600 }
		.badge-status-unpaid { background:#ff5b6b; color:#fff; padding:4px 8px; border-radius:10px; font-size:12px; font-weight:600 }
		.badge-status-partial { background:#ffcc33; color:#07121a; padding:4px 8px; border-radius:10px; font-size:12px; font-weight:600 }
	</style>
</head>
<body>
	<div class="app">
		<aside class="sidebar card">
			<div class="brand">Mipc Computadores</div>
			<ul class="menu">
				<li class="active" data-view="orders">Órdenes</li>
				<li data-view="clients">Clientes</li>
				<li data-view="invoices">Facturas</li> <!-- NUEVO -->
				<li data-view="finance">Finanzas</li>
				<li data-view="inventory">Inventario</li>
				<li data-view="settings">Configuración</li>
			</ul>
			<div style="margin-top:20px" class="small">Puedes exportar/importar desde Configuración.</div>
		</aside>

		<main class="main">
			<div class="header">
				<h2 id="view-title">Órdenes</h2>
				<div class="controls">
					<button class="btn" id="btn-add-order">+ Nueva orden</button>
					<button class="btn" id="btn-add-client" style="display:none;background:#3bb4ff;color:#04121a">+ Nuevo cliente</button>
					<span id="conn-status" class="small" style="margin-left:8px">Conectando…</span>
				</div>
			</div>

			<section id="orders-section" class="card">
				<div class="small filters">
					Filtrar:
					<input id="filter-input" placeholder="buscar por cliente, serie o modelo" style="margin-left:8px;padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
					<!-- nuevo: filtro por estado -->
					<select id="status-filter" style="margin-left:8px;padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
						<option value="">Todos los estados</option>
						<option value="ingresado">Ingresado</option>
						<option value="en_reparacion">En reparación</option>
						<option value="espera_entrega">En espera de entrega</option>
						<option value="entregado">Entregado</option>
					</select>
					<!-- nuevo: filtro por estado de pago -->
					<select id="payment-filter" style="margin-left:8px;padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
						<option value="">Todos (pagos)</option>
						<option value="paid">Pagadas</option>
						<option value="unpaid">No pagadas</option>
					</select>
				</div>

				<!-- NUEVO: envoltorio con scroll horizontal -->
				<div class="table-scroll">
					<table id="orders-table" aria-label="Órdenes">
						<thead>
							<tr>
								<th>ID</th><th>Cliente</th><th>Marca</th><th>Modelo</th><th>Serie</th><th>Accesorios</th><th>Falla</th>
								<th>Estado</th><th>Precio</th><th>Pago</th><th>Imágenes</th><th>Técnico</th><th>Fecha</th><th>Acciones</th>
							</tr>
						</thead>
						<tbody>
							<!-- filas generadas por JS -->
						</tbody>
					</table>
				</div>
				<div class="footer-note" id="orders-count"></div>
			</section>

			<section id="clients-section" class="card" style="display:none;margin-top:12px">
				<h3>Clientes</h3>
				<button class="btn" id="btn-new-client-inline" style="margin-bottom:8px">+ Nuevo cliente</button>
				<!-- NUEVO: envoltorio con scroll horizontal -->
				<div class="table-scroll">
					<table id="clients-table">
						<thead><tr><th>ID</th><th>Nombre</th><th>Cédula</th><th>Teléfono</th><th>Email</th><th>Acciones</th></tr></thead>
						<tbody></tbody>
					</table>
				</div>
			</section>

			<!-- Nueva sección: Finanzas -->
			<section id="finance-section" class="card" style="display:none;margin-top:12px">
				<h3>Finanzas</h3>
				<!-- Panel métricas -->
				<div id="finance-metrics" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
					<!-- contenido poblado por JS -->
				</div>
				<!-- pequeño ajuste: permitir wrap en controles -->
				<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
					<button class="btn" id="btn-new-transaction">+ Nueva transacción</button>
					<div id="finance-summary" class="small" style="margin-left:12px">Cargando...</div>
					<!-- filtros: tipo y categoría -->
					<select id="type-filter" style="margin-left:12px;padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
						<option value="">Todos</option>
						<option value="income">Ingresos</option>
						<option value="expense">Gastos</option>
					</select>
					<select id="category-filter" style="margin-left:8px;padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
						<option value="">Todas las categorías</option>
						<!-- opciones pobladas por JS -->
					</select>
				</div>
				<!-- Formulario inline para nueva transacción -->
				<form id="form-transaction" style="display:block;margin-bottom:8px;gap:8px">
					<div class="form-row">
						<select name="type" required>
							<option value="income">Ingreso</option>
							<option value="expense">Gasto</option>
						</select>
						<input name="amount" type="number" step="0.01" placeholder="Monto" required>
					</div>
					<div class="form-row">
						<select name="category" id="tx-category" required>
							<!-- opciones pobladas por JS -->
						</select>
						<input name="date" type="date" value="">
					</div>
					<div class="form-row">
						<input name="notes" placeholder="Notas" style="flex:2">
						<button class="btn" type="submit">Guardar</button>
					</div>
				</form>

				<!-- NUEVO: envoltorio con scroll horizontal -->
				<div class="table-scroll">
					<table id="transactions-table">
						<thead><tr><th>ID</th><th>Tipo</th><th>Monto</th><th>Categoría</th><th>Fecha</th><th>Notas</th><th>Acciones</th></tr></thead>
						<tbody></tbody>
					</table>
				</div>
			</section>

			<!-- NUEVO: Sección Inventario -->
			<section id="inventory-section" class="card" style="display:none;margin-top:12px">
				<h3>Inventario</h3>
				<div class="controls">
					<button class="btn" id="btn-new-item">+ Nuevo ítem</button>
					<input id="inv-filter" placeholder="Buscar por nombre o categoría">
					<div class="small" id="inventory-summary">Cargando...</div>
				</div>

				<div class="table-scroll">
					<table id="inventory-table">
						<thead>
							<tr>
								<th>ID</th>
								<th>Nombre</th>
								<th>Categoría</th>
								<th>Stock</th>
								<th>Costo u.</th>
								<th>Precio u.</th>
								<th>Proveedor</th>
								<th>Actualizado</th>
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</section>

			<!-- NUEVO: Sección Facturas -->
			<section id="invoices-section" class="card" style="display:none;margin-top:12px">
				<h3>Facturas</h3>
				<div class="controls">
					<button class="btn" id="btn-new-invoice">+ Nueva factura</button>
					<input id="invoice-filter" placeholder="Buscar por cliente o número">
					<div class="small" id="invoices-summary">Cargando...</div>
				</div>

				<div class="table-scroll">
					<table id="invoices-table">
						<thead>
							<tr>
								<th>Número</th>
								<th>Cliente</th>
								<th>Fecha</th>
								<th>Subtotal</th>
								<th>IVA</th>
								<th>Total</th>
								<th>Estado</th>
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>
				</div>
			</section>

			<section id="settings-section" class="card" style="display:none;margin-top:12px">
				<h3>Configuración</h3>
				<button class="btn" id="export-data">Exportar datos (.json)</button>
				<button class="btn" id="import-data" style="background:#3bb4ff;color:#04121a">Importar</button>
				<!-- nuevo: exportar PDF de órdenes -->
				<button class="btn" id="export-pdf" style="margin-left:8px;background:#7af0a5;color:#04121a">Exportar PDF (Órdenes)</button>
				<input type="file" id="import-file" accept="application/json" style="display:none">
				<div class="footer-note" style="margin-top:12px">Equipos guardados en hoja de vida por número de serie.</div>
			</section>
		</main>
	</div>

	<!-- Modal: agregar/editar orden -->
	<div class="modal" id="modal-order">
		<div class="panel">
			<h3 id="modal-order-title">Nueva orden</h3>
			<form id="form-order">
				<div class="form-row">
					<select name="clientId" required>
						<option value="">-- Seleccionar cliente --</option>
					</select>
					<button type="button" class="btn" id="btn-order-new-client" style="background:#64707a">Nuevo cliente</button>
				</div>

				<!-- nuevo: selector de estado -->
				<div class="form-row">
					<select name="status" required>
						<option value="ingresado">Ingresado</option>
						<option value="en_reparacion">En reparación</option>
						<option value="espera_entrega">En espera de entrega</option>
						<option value="entregado">Entregado</option>
					</select>
					<!-- espacio para futuro -->
					<input name="brand" placeholder="Marca" required>
				</div>

				<div class="form-row">
					<input name="serial" placeholder="Número de serie (único)" required>
					<input name="model" placeholder="Modelo">
				</div>
				<div class="form-row">
					<input name="accessories" placeholder="Accesorios (ej: cargador, funda)">
					<textarea name="failure" placeholder="Falla reportada" rows="1" required style="flex:2"></textarea>
				</div>

				<div class="form-row">
					<input name="technician" placeholder="Técnico asignado">
					<input name="price" type="number" step="0.01" placeholder="Precio" style="flex:1">
					<!-- nuevo: selector de estado de pago -->
					<select name="paid" style="flex:1">
						<option value="false">No pagado</option>
						<option value="true">Pagado</option>
					</select>
				</div>

				<div class="form-row">
					<input name="notes" placeholder="Notas internas" style="flex:1">
				</div>

				<!-- nuevo: campo para imágenes -->
				<div class="form-row" style="flex-direction:column;align-items:flex-start">
					<label style="color:var(--muted);font-size:13px;margin-bottom:4px">
						Imágenes del equipo: 
						<span id="image-count" style="color:var(--accent);font-weight:600">(0 imágenes)</span>
					</label>
					<input type="file" id="order-images" accept="image/*" multiple style="padding:6px;border-radius:6px;background:#052026;border:1px solid rgba(255,255,255,.04);color:#dfeef2">
					<div id="image-preview-container" class="image-preview-container"></div>
				</div>

				<div style="display:flex;gap:8px;justify-content:flex-end">
					<button type="button" class="btn" id="btn-close-order" style="background:#64707a">Cancelar</button>
					<button type="submit" class="btn">Guardar orden</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Modal: cliente -->
	<div class="modal" id="modal-client">
		<div class="panel">
			<h3 id="modal-client-title">Nuevo cliente</h3>
			<form id="form-client">
				<!-- cambiado: ahora se pide la cédula -->
				<div class="form-row">
					<input name="name" placeholder="Nombre" required>
					<input name="cedula" placeholder="Cédula" required>
				</div>
				<div class="form-row">
					<input name="phone" placeholder="Teléfono">
					<input name="email" placeholder="Email">
				</div>
				<div class="form-row">
					<input name="address" placeholder="Dirección">
				</div>
				<div style="display:flex;gap:8px;justify-content:flex-end">
					<button type="button" class="btn" id="btn-close-client" style="background:#64707a">Cancelar</button>
					<button type="submit" class="btn" style="background:#3bb4ff;color:#04121a">Guardar</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Modal: equipo / hoja de vida -->
	<div class="modal" id="modal-equipment">
		<div class="panel">
			<h3 id="modal-equipment-title">Hoja de vida - Equipo</h3>
			<div class="history-list" id="equipment-history"></div>
			<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
				<button type="button" class="btn" id="btn-close-equipment" style="background:#64707a">Cerrar</button>
			</div>
		</div>
	</div>

	<!-- NUEVO: Modal ítem de inventario -->
	<div class="modal" id="modal-inventory-item">
		<div class="panel">
			<h3 id="modal-inventory-title">Nuevo ítem</h3>
			<form id="form-inventory-item">
				<div class="form-row">
					<input name="name" placeholder="Nombre" required>
					<input name="category" placeholder="Categoría">
				</div>
				<div class="form-row">
					<input name="stock" type="number" step="1" min="0" placeholder="Stock inicial" value="0">
					<input name="unitCost" type="number" step="0.01" placeholder="Costo unitario">
					<input name="unitPrice" type="number" step="0.01" placeholder="Precio unitario">
				</div>
				<div class="form-row">
					<input name="supplier" placeholder="Proveedor">
					<input name="notes" placeholder="Notas" style="flex:2">
				</div>
				<div style="display:flex;gap:8px;justify-content:flex-end">
					<button type="button" class="btn" id="btn-close-inventory-item" style="background:#64707a">Cancelar</button>
					<button type="submit" class="btn">Guardar</button>
				</div>
			</form>
		</div>
	</div>

	<!-- NUEVO: Modal movimiento (entrada/salida) -->
	<div class="modal" id="modal-movement">
		<div class="panel">
			<h3 id="modal-movement-title">Registrar movimiento</h3>
			<form id="form-movement">
				<input type="hidden" name="itemId">
				<input type="hidden" name="type"> <!-- in | out -->
				<div class="form-row">
					<input name="qty" type="number" step="1" min="1" placeholder="Cantidad" required>
					<input name="unitValue" type="number" step="0.01" placeholder="Valor unitario">
				</div>
				<div class="form-row">
					<input name="notes" placeholder="Notas">
					<input name="date" type="date">
				</div>
				<div style="display:flex;gap:8px;justify-content:flex-end">
					<button type="button" class="btn" id="btn-close-movement" style="background:#64707a">Cancelar</button>
					<button type="submit" class="btn">Registrar</button>
				</div>
				<div class="small" id="movement-hint" style="margin-top:6px;color:#9aa5b1"></div>
			</form>
		</div>
	</div>

	<!-- NUEVO: Modal historial de movimientos -->
	<div class="modal" id="modal-movements-history">
		<div class="panel">
			<h3 id="modal-movements-title">Historial de movimientos</h3>
			<div class="history-list" id="movements-history"></div>
			<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
				<button type="button" class="btn" id="btn-close-movements" style="background:#64707a">Cerrar</button>
			</div>
		</div>
	</div>

	<!-- NUEVO: Modal crear/editar factura -->
	<div class="modal" id="modal-invoice">
		<div class="panel" style="max-width:800px;width:90%">
			<h3 id="modal-invoice-title">Nueva factura</h3>
			<form id="form-invoice">
				<div class="form-row">
					<select name="clientId" required>
						<option value="">-- Seleccionar cliente --</option>
					</select>
					<input name="invoiceNumber" placeholder="Número de factura (auto)" readonly style="background:#031419">
				</div>
				<div class="form-row">
					<input name="date" type="date" required>
					<select name="paymentStatus">
						<option value="unpaid">No pagada</option>
						<option value="partial">Pago parcial</option>
						<option value="paid">Pagada</option>
					</select>
				</div>
				<div class="form-row">
					<textarea name="notes" placeholder="Notas (opcional)" rows="2"></textarea>
				</div>

				<!-- Ítems de la factura -->
				<div style="margin-top:12px">
					<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
						<strong>Ítems de la factura</strong>
						<button type="button" class="btn" id="btn-add-invoice-item" style="background:#3bb4ff;color:#04121a;font-size:12px;padding:6px 10px">+ Agregar ítem</button>
					</div>
					<div class="invoice-items-list" id="invoice-items-list">
						<!-- ítems dinámicos -->
					</div>
				</div>

				<!-- Totales -->
				<div style="margin-top:12px;padding:10px;background:#051820;border-radius:6px">
					<div style="display:flex;justify-content:space-between;margin-bottom:4px">
						<span>Subtotal:</span>
						<span id="invoice-subtotal">$0.00</span>
					</div>
					<div style="display:flex;justify-content:space-between;margin-bottom:4px">
						<span>IVA (19%):</span>
						<span id="invoice-tax">$0.00</span>
					</div>
					<div style="display:flex;justify-content:space-between;font-size:16px;font-weight:700;color:var(--accent);padding-top:8px;border-top:1px solid rgba(255,255,255,.1)">
						<span>Total:</span>
						<span id="invoice-total">$0.00</span>
					</div>
				</div>

				<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
					<button type="button" class="btn" id="btn-close-invoice" style="background:#64707a">Cancelar</button>
					<button type="submit" class="btn">Guardar factura</button>
				</div>
			</form>
		</div>
	</div>

	<!-- incluir jsPDF desde CDN -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

	<script>
		// NUEVO: configuración de API con fallback y caché local
		const REMOTE_API = "https://rides-prefer-seal-becomes.trycloudflare.com/api"; // puede ser inestable
		let lastApiBase = localStorage.getItem('API_URL_LAST') || null;
		let API_TIMEOUT_MS = Number(localStorage.getItem('API_TIMEOUT_MS')||'1200') || 1200; // tiempo máximo por intento de API

		function getApiCandidates(){
			const override = localStorage.getItem('API_URL_OVERRIDE');
			const sameOrigin = (location.origin && location.origin.startsWith('http')) ? (location.origin + '/api') : null;
			const local = 'http://localhost:3000/api';
			const list = [];
			// priorizar la última API que funcionó
			if(lastApiBase) list.push(lastApiBase);
			if(override) list.push(override);
			if(sameOrigin && !list.includes(sameOrigin)) list.push(sameOrigin);
			if(!list.includes(local)) list.push(local);
			if(!list.includes(REMOTE_API)) list.push(REMOTE_API);
			return list;
		}

		function setOnline(ok, base){
			const el = document.getElementById('conn-status');
			if(!el) return;
			if(ok){
				lastApiBase = base || lastApiBase;
				if(lastApiBase){ try{ localStorage.setItem('API_URL_LAST', lastApiBase); }catch{} }
				el.textContent = 'Conectado';
				el.style.color = '#7af0a5';
				if(base) el.title = base;
			} else {
				el.textContent = 'Sin conexión (datos locales)';
				el.style.color = '#ffcc33';
			}
		}

		// helper: fetch con timeout
		async function fetchWithTimeout(url, options={}, timeoutMs=API_TIMEOUT_MS){
			const controller = new AbortController();
			const id = setTimeout(()=> controller.abort(), timeoutMs);
			try{
				const res = await fetch(url, { ...options, signal: controller.signal });
				return res;
			} finally {
				clearTimeout(id);
			}
		}

		// funciones reutilizables para comunicarse con el backend
		async function loadTable(table) {
			const cacheKey = `cache:${table}`;
			const bases = getApiCandidates();
			const attempts = bases.map(base => (
				fetchWithTimeout(`${base}/${table}`, { method:'GET' })
					.then(async res => {
						if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
						const data = await res.json();
						return { base, data };
					})
			));
			try{
				// tomar la primera respuesta exitosa
				const { base, data } = await Promise.any(attempts);
				try{ localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data })); }catch{}
				setOnline(true, base);
				return Array.isArray(data) ? data : [];
			}catch(err){
				console.warn(`Todas las APIs fallaron en GET ${table}:`, err && err.message ? err.message : err);
				// Fallback a caché
				try{
					const cached = localStorage.getItem(cacheKey);
					if(cached){
						const obj = JSON.parse(cached);
						setOnline(false);
						return Array.isArray(obj.data) ? obj.data : [];
					}
				}catch{}
				setOnline(false);
				return [];
			}
		}

		async function saveTable(table, data) {
			const cacheKey = `cache:${table}`;
			const bases = getApiCandidates();
			for(const base of bases){
				try{
					const res = await fetchWithTimeout(`${base}/${table}`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(data)
					}, API_TIMEOUT_MS);
					if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
					try{ localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data })); }catch{}
					setOnline(true, base);
					return;
				}catch(err){
					console.warn(`Fallo guardando en ${base} (${table})`, err && err.message ? err.message : err);
				}
			}
			// si todas fallan, guardar en caché para no perder datos y no bloquear
			try{ localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data })); }catch{}
			setOnline(false);
		}

		// Storage helpers (ahora asíncronos y delegan a loadTable/saveTable)
		async function loadOrders(){ return await loadTable('orders'); }
		async function saveOrders(list){ await saveTable('orders', list); }
		async function loadClients(){ return await loadTable('clients'); }
		async function saveClients(list){ await saveTable('clients', list); }
		async function loadEquipments(){ return await loadTable('equipments'); }
		async function saveEquipments(list){ await saveTable('equipments', list); }
		async function loadTransactions(){ return await loadTable('transactions'); }
		async function saveTransactions(list){ await saveTable('transactions', list); }
		// NUEVO: helpers de inventario (API)
		async function loadInventory(){ return await loadTable('inventory'); }
		async function saveInventory(list){ await saveTable('inventory', list); }
		async function loadInventoryMovements(){ return await loadTable('inventory_movements'); }
		async function saveInventoryMovements(list){ await saveTable('inventory_movements', list); }
		// NUEVO: helpers de facturas (API)
		async function loadInvoices(){ return await loadTable('invoices'); }
		async function saveInvoices(list){ await saveTable('invoices', list); }

		// Categorías predefinidas para Finanzas
		const FINANCE_CATEGORIES = ['Servicios','Repuestos','Ventas','Nomina','Otros', 'Inventario']; // NUEVO: 'Inventario'

		// pobla los selects de categoría (#category-filter y #tx-category)
		async function populateFinanceCategorySelects(){
			const catSet = new Set(FINANCE_CATEGORIES);
			try {
				const tx = await loadTransactions();
				(tx || []).forEach(t => { if(t && t.category) catSet.add(t.category); });
			} catch(e){
				console.warn('No se pudieron leer transacciones para categorías', e);
			}

			const list = Array.from(catSet);
			const catFilter = $('#category-filter');
			const txCat = $('#tx-category');
			if(catFilter){
				const selOld = catFilter.value || '';
				catFilter.innerHTML = '<option value="">Todas las categorías</option>';
				list.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; catFilter.appendChild(o); });
				if(selOld) catFilter.value = selOld;
			}
			if(txCat){
				const selOld2 = txCat.value || '';
				txCat.innerHTML = '';
				list.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; txCat.appendChild(o); });
				if(selOld2) txCat.value = selOld2;
			}
		}

		// nuevos: estados válidos (clave -> etiqueta)
		const ORDER_STATUSES = {
			ingresado: 'Ingresado',
			en_reparacion: 'En reparación',
			espera_entrega: 'En espera de entrega',
			entregado: 'Entregado'
		};

		// util
		const $ = sel => document.querySelector(sel);
		const $$ = sel => Array.from(document.querySelectorAll(sel));

		// estado
		let editingOrderId = null;
		let editingClientId = null;
		// NUEVO: estado inventario
		let editingItemId = null;
		let currentMovementItemId = null;
		let currentMovementType = null; // 'in' | 'out'
		// NUEVO: estado de facturas
		let editingInvoiceId = null;
		let invoiceItems = []; // ítems temporales de la factura actual

		// init
		document.addEventListener('DOMContentLoaded', async ()=> {
			bindUI();
			renderView('orders');
			await renderOrders();
			await renderClients();
			await populateFinanceCategorySelects();
			await renderFinance();
			await renderInventory();
			await renderInvoices(); // NUEVO
		});

		function bindUI(){
			// menu
			$$('.menu li').forEach(li=>{
				li.addEventListener('click', e=>{
					$$('.menu li').forEach(x=>x.classList.remove('active'));
					li.classList.add('active');
					renderView(li.dataset.view);
				});
			});

			$('#btn-add-order').addEventListener('click', ()=> openOrderModal());
			$('#btn-order-new-client').addEventListener('click', ()=> openClientModal());
			$('#btn-new-client-inline').addEventListener('click', ()=> openClientModal());
			$('#btn-add-client').addEventListener('click', ()=> openClientModal());

			$('#btn-close-order').addEventListener('click', ()=> closeModal('#modal-order'));
			$('#btn-close-client').addEventListener('click', ()=> closeModal('#modal-client'));
			$('#btn-close-equipment').addEventListener('click', ()=> closeModal('#modal-equipment'));
			const btnCloseItem = document.getElementById('btn-close-inventory-item');
			if(btnCloseItem) btnCloseItem.addEventListener('click', ()=> closeModal('#modal-inventory-item'));
			const btnCloseMove = document.getElementById('btn-close-movement');
			if(btnCloseMove) btnCloseMove.addEventListener('click', ()=> closeModal('#modal-movement'));
			const btnCloseMovs = document.getElementById('btn-close-movements');
			if(btnCloseMovs) btnCloseMovs.addEventListener('click', ()=> closeModal('#modal-movements-history'));

			$('#form-order').addEventListener('submit', async (e)=> await saveOrderFromForm(e));
			$('#form-client').addEventListener('submit', async (e)=> await saveClientFromForm(e));
			const formItem = document.getElementById('form-inventory-item');
			if(formItem) formItem.addEventListener('submit', async (e)=> await saveInventoryItemFromForm(e));
			const formMove = document.getElementById('form-movement');
			if(formMove) formMove.addEventListener('submit', async (e)=> await saveMovementFromForm(e));

			// nuevo: manejo de imágenes
			$('#order-images').addEventListener('change', handleImageUpload);

			$('#filter-input').addEventListener('input', async ()=> await renderOrders());
			$('#status-filter').addEventListener('change', async ()=> await renderOrders());
			$('#payment-filter').addEventListener('change', async ()=> await renderOrders()); // nuevo: filtro de pago

			$('#export-data').addEventListener('click', async ()=> await exportData());
			$('#import-data').addEventListener('click', ()=> $('#import-file').click());
			$('#import-file').addEventListener('change', async (e)=> await importDataFile(e));
			// binding para exportar PDF
			const pdfBtn = $('#export-pdf');
			if(pdfBtn) pdfBtn.addEventListener('click', async ()=> await exportOrdersPDF());

			// Finanzas: bindings
			const txBtn = $('#btn-new-transaction');
			if(txBtn) txBtn.addEventListener('click', ()=> {
				const form = $('#form-transaction');
				form.reset();
				// fecha por defecto hoy
				const d = new Date().toISOString().slice(0,10);
				form.querySelector('input[name="date"]').value = d;
				// seleccionar primera categoría por defecto si existe
				const catSel = form.querySelector('select[name="category"]');
				if(catSel && catSel.options.length>0) catSel.selectedIndex = 0;
				form.querySelector('input[name="amount"]').focus();
			});
			const txForm = $('#form-transaction');
			if(txForm) txForm.addEventListener('submit', async (e)=> await saveTransactionFromForm(e));

			// filtros: recargar render cuando cambian
			const typeFilter = $('#type-filter');
			if(typeFilter) typeFilter.addEventListener('change', async ()=> await renderFinance());
			const catFilter = $('#category-filter');
			if(catFilter) catFilter.addEventListener('change', async ()=> await renderFinance());

			// NUEVO: bindings inventario
			const btnNewItem = document.getElementById('btn-new-item');
			if(btnNewItem) btnNewItem.addEventListener('click', ()=> openInventoryItemModal());

			const invFilter = document.getElementById('inv-filter');
			if(invFilter) invFilter.addEventListener('input', async ()=> await renderInventory());

			// NUEVO: bindings facturas
			const btnNewInvoice = document.getElementById('btn-new-invoice');
			if(btnNewInvoice) btnNewInvoice.addEventListener('click', ()=> openInvoiceModal());

			const btnCloseInvoice = document.getElementById('btn-close-invoice');
			if(btnCloseInvoice) btnCloseInvoice.addEventListener('click', ()=> closeModal('#modal-invoice'));

			const formInvoice = document.getElementById('form-invoice');
			if(formInvoice) formInvoice.addEventListener('submit', async (e)=> await saveInvoiceFromForm(e));

			const btnAddInvoiceItem = document.getElementById('btn-add-invoice-item');
			if(btnAddInvoiceItem) btnAddInvoiceItem.addEventListener('click', ()=> addInvoiceItemRow());

			const invoiceFilter = document.getElementById('invoice-filter');
			if(invoiceFilter) invoiceFilter.addEventListener('input', async ()=> await renderInvoices());
		}

		async function renderView(view){
			$('#view-title').textContent = view === 'orders' ? 'Órdenes' : view === 'clients' ? 'Clientes' : view === 'invoices' ? 'Facturas' : view === 'finance' ? 'Finanzas' : view === 'inventory' ? 'Inventario' : 'Configuración';
			$('#orders-section').style.display = view === 'orders' ? 'block' : 'none';
			$('#clients-section').style.display = view === 'clients' ? 'block' : 'none';
			$('#invoices-section').style.display = view === 'invoices' ? 'block' : 'none'; // NUEVO
			$('#finance-section').style.display = view === 'finance' ? 'block' : 'none';
			$('#inventory-section').style.display = view === 'inventory' ? 'block' : 'none';
			$('#settings-section').style.display = view === 'settings' ? 'block' : 'none';
			$('#btn-add-client').style.display = view === 'clients' ? 'inline-block' : 'none';
		}

		// Render órdenes (ahora asíncrono)
		async function renderOrders(){
			const tbody = $('#orders-table tbody');
			const filter = $('#filter-input').value.toLowerCase().trim();
			const statusFilter = $('#status-filter').value;
			const paymentFilter = $('#payment-filter').value; // nuevo
			const all = await loadOrders();
			const items = all.filter(o=>{
				if(statusFilter && (o.status||'ingresado') !== statusFilter) return false;
				// nuevo: filtro de pago
				if(paymentFilter === 'paid' && !o.paid) return false;
				if(paymentFilter === 'unpaid' && o.paid) return false;
				if(!filter) return true;
				// findClientById es asíncrona, pero aquí ya tenemos clientes cargados en memoria si queremos rendimiento.
				// Para simplicidad hacemos una búsqueda síncrona en clientes cargados (cargamos la lista).
				const client = (async ()=> { const cl = await loadClients(); return cl.find(c=>c.id==o.clientId) || {}; })();
				// como client es Promise, mejor cargar clientes antes
			});
			// Mejor enfoque: cargar clientes antes de filtrar
			const clients = await loadClients();
			const filtered = all.filter(o=>{
				if(statusFilter && (o.status||'ingresado') !== statusFilter) return false;
				if(paymentFilter === 'paid' && !o.paid) return false;
				if(paymentFilter === 'unpaid' && o.paid) return false;
				if(!filter) return true;
				const client = clients.find(c=>c.id==o.clientId) || {};
				return [client.name, o.brand, o.model, o.serial, o.accessories, o.failure, ORDER_STATUSES[o.status]||''].join(' ').toLowerCase().includes(filter);
			});
			tbody.innerHTML = '';
			filtered.forEach(o=>{
				const client = clients.find(c=>c.id==o.clientId) || {name:'--'};
				const statusKey = o.status || 'ingresado';
				const statusLabel = ORDER_STATUSES[statusKey] || statusKey;
				const statusClass = `status-${statusKey}`;
				const imageCount = (o.images && o.images.length) ? o.images.length : 0;
				const priceDisplay = o.price ? formatCurrency(Number(o.price)) : '--';
				// nuevo: estado de pago
				const isPaid = o.paid === true;
				const paymentBadge = isPaid 
					? '<span class="payment-badge payment-paid">Pagado</span>' 
					: '<span class="payment-badge payment-unpaid">No pagado</span>';
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td>${o.id}</td>
					<td>${escapeHtml(client.name)}</td>
					<td>${escapeHtml(o.brand||'')}</td>
					<td>${escapeHtml(o.model||'')}</td>
					<td><button type="button" class="btn btn-view-eq" data-serial="${escapeHtml(o.serial||'')}">${escapeHtml(o.serial||'')}</button></td>
					<td>${escapeHtml(o.accessories||'')}</td>
					<td>${escapeHtml(o.failure||'')}</td>
					<td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
					<td>${priceDisplay}</td>
					<td>${paymentBadge}</td>
					<td style="text-align:center">${imageCount}</td>
					<td>${escapeHtml(o.technician||'')}</td>
					<td>${new Date(o.date).toLocaleString()}</td>
					<td class="actions">
						<select class="inline-status" data-id="${o.id}">
							<option value="ingresado"${statusKey==='ingresado'?' selected':''}>Ingresado</option>
							<option value="en_reparacion"${statusKey==='en_reparacion'?' selected':''}>En reparación</option>
							<option value="espera_entrega"${statusKey==='espera_entrega'?' selected':''}>En espera de entrega</option>
							<option value="entregado"${statusKey==='entregado'?' selected':''}>Entregado</option>
						</select>
						<button class="btn btn-toggle-payment" data-id="${o.id}" title="Cambiar estado de pago">${isPaid ? '💰 Pagado' : '💳 Marcar pagado'}</button>
						<button class="btn btn-copy-link" data-id="${o.id}" style="background:#9c27b0;color:#fff" title="Copiar enlace público">🔗 Link</button>
						<button class="btn btn-edit" data-id="${o.id}">Editar</button>
						<button class="btn btn-delete" data-id="${o.id}">Eliminar</button>
						<button class="btn" style="background:#071a2a;color:#7af0a5" data-id="${o.id}" class="btn-pdf">PDF</button>
						<button class="btn btn-whatsapp" data-id="${o.id}" style="background:#25D366;color:#06121a">WhatsApp</button>
					</td>
				`;
				tbody.appendChild(tr);
			});

			// acciones
			$$('.btn-edit').forEach(b=>b.onclick = ()=> openOrderModal(b.dataset.id));
			$$('.btn-delete').forEach(b=>b.onclick = async ()=> { if(confirm('Eliminar orden?')) await deleteOrder(b.dataset.id) });
			$$('select.inline-status').forEach(s=>{
				s.onchange = async ()=> await updateOrderStatus(s.dataset.id, s.value);
			});
			// nuevo: toggle de pago
			$$('.btn-toggle-payment').forEach(b => b.onclick = async ()=> await toggleOrderPayment(b.dataset.id));

			// botón PDF por orden
			$$('button[data-id]').filter(b => b.classList.contains('btn') && b.textContent === 'PDF')
				.forEach(b => b.onclick = ()=> exportOrderPDF(b.dataset.id));

			// botón WhatsApp por orden
			$$('.btn-whatsapp').forEach(b => b.onclick = ()=> openWhatsApp(b.dataset.id));

			// nuevo: copiar enlace público
			$$('.btn-copy-link').forEach(b => b.onclick = async ()=> await copyPublicLink(b.dataset.id));

			// abrir hoja de vida
			$$('.btn-view-eq').forEach(b=> b.onclick = ()=> {
				const serial = b.dataset.serial;
				if(!serial) return alert('Serie inválida');
				openEquipmentModal(serial);
			});

			$('#orders-count').textContent = `Mostrando ${filtered.length} registros`;
			// actualizar métricas cuando se renderizan órdenes
			await computeMetrics();
		}

		// eliminar orden (ahora asíncrono)
		async function deleteOrder(id){
			const list = (await loadOrders()).filter(x=>x.id!=id);
			await saveOrders(list);
			await renderOrders();
			await renderFinance();
			await computeMetrics();
		}

		// Generar PDF para una sola orden (sincrónico en su uso pero puede ser async)
		async function exportOrderPDF(id){
			const orders = await loadOrders();
			const order = orders.find(o=>o.id==id);
			if(!order) return alert('Orden no encontrada');
			
			// generar token si no existe
			if(!order.accessToken){
				order.accessToken = generateAccessToken();
				await saveOrders(orders);
			}
			
			const client = (await loadClients()).find(c=>c.id==order.clientId) || {name:'--', phone:'', email:''};
			const publicLink = getPublicOrderLink(order);
			
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({unit:'pt', format:'letter'});
			const pageWidth = doc.internal.pageSize.width;
			const pageHeight = doc.internal.pageSize.height;
			const margin = 60;
			const centerX = pageWidth / 2;
			let y = margin + 20;
			
			// Cargar y agregar logo
			try {
				const logoImage = await loadImageFromUrl('./image.png');
				const logoSize = 60; // Tamaño del logo
				doc.addImage(logoImage, 'PNG', centerX - logoSize/2, y, logoSize, logoSize);
				y += logoSize + 15;
			} catch(err) {
				console.error('Error cargando logo:', err);
				// Fallback al logo tipográfico si no se puede cargar la imagen
				doc.setFontSize(20);
				doc.setFont(undefined, 'bold');
				const titleWidth = doc.getTextWidth('MIPC COMPUTADORES');
				doc.text('MIPC COMPUTADORES', centerX - titleWidth/2, y);
				y += 30;
			}
			
			// Título del documento
			doc.setFontSize(18);
			doc.setFont(undefined, 'bold');
			doc.setTextColor(0, 0, 0); // Asegurar color negro
			const serviceTitle = 'ORDEN DE SERVICIO';
			const serviceTitleWidth = doc.getTextWidth(serviceTitle);
			doc.text(serviceTitle, centerX - serviceTitleWidth/2, y);
			y += 30;
			
			// Línea separadora
			doc.setLineWidth(1);
			doc.line(margin, y, pageWidth - margin, y);
			y += 25;
			
			// Información en dos columnas
			doc.setFontSize(11);
			doc.setFont(undefined, 'normal');
			
			const leftColumn = margin + 20;
			const rightColumn = centerX + 20;
			const startY = y;
			
			// Columna izquierda - Información de la orden
			y = startY;
			doc.setFont(undefined, 'bold');
			doc.text('INFORMACIÓN DE LA ORDEN', leftColumn, y);
			y += 20;
			doc.setFont(undefined, 'normal');
			
			const orderInfo = [
				`ID: ${order.id}`,
				`Fecha: ${order.date ? new Date(order.date).toLocaleString() : ''}`,
				`Estado: ${ORDER_STATUSES[order.status||'ingresado'] || order.status}`,
				`Pago: ${order.paid ? 'Pagado' : 'No pagado'}`,
				`Precio: ${order.price ? formatCurrency(Number(order.price)) : 'No especificado'}`,
				`Técnico: ${order.technician||'No asignado'}`
			];
			
			orderInfo.forEach(line => {
				doc.text(line, leftColumn, y);
				y += 15;
			});
			
			// Columna derecha - Información del cliente
			y = startY;
			doc.setFont(undefined, 'bold');
			doc.text('INFORMACIÓN DEL CLIENTE', rightColumn, y);
			y += 20;
			doc.setFont(undefined, 'normal');
			
			const clientInfo = [
				`Nombre: ${client.name}`,
				`Teléfono: ${client.phone||'No especificado'}`,
				`Email: ${client.email||'No especificado'}`,
				`Cédula: ${client.cedula||'No especificado'}`
			];
			
			clientInfo.forEach(line => {
				doc.text(line, rightColumn, y);
				y += 15;
			});
			
			// Información del equipo (ancho completo)
			y = Math.max(startY + (orderInfo.length * 15) + 40, startY + (clientInfo.length * 15) + 40);
			
			doc.setFont(undefined, 'bold');
			doc.text('INFORMACIÓN DEL EQUIPO', leftColumn, y);
			y += 20;
			doc.setFont(undefined, 'normal');
			
			const equipInfo = [
				`Marca: ${order.brand||'No especificado'}`,
				`Modelo: ${order.model||'No especificado'}`,
				`Serie: ${order.serial||'No especificado'}`,
				`Accesorios: ${order.accessories||'Ninguno'}`
			];
			
			equipInfo.forEach(line => {
				doc.text(line, leftColumn, y);
				y += 15;
			});
			
			// Falla reportada
			y += 10;
			doc.setFont(undefined, 'bold');
			doc.text('FALLA REPORTADA:', leftColumn, y);
			y += 15;
			doc.setFont(undefined, 'normal');
			
			const failureText = order.failure || 'No especificada';
			const failureLines = wrapText(failureText, 80);
			if(Array.isArray(failureLines)){
				failureLines.forEach(line => {
					doc.text(line, leftColumn, y);
					y += 15;
				});
			} else {
				doc.text(failureLines, leftColumn, y);
				y += 15;
			}
			
			// Notas (si existen)
			if(order.notes){
				y += 10;
				doc.setFont(undefined, 'bold');
				doc.text('NOTAS:', leftColumn, y);
				y += 15;
				doc.setFont(undefined, 'normal');
				
				const notesLines = wrapText(order.notes, 80);
				if(Array.isArray(notesLines)){
					notesLines.forEach(line => {
						doc.text(line, leftColumn, y);
						y += 15;
					});
				} else {
					doc.text(notesLines, leftColumn, y);
					y += 15;
				}
			}
			
			// Sección QR centrada en la parte inferior
			y += 30;
			const qrSize = 80;
			
			// Verificar si hay espacio, sino crear nueva página
			if(y + qrSize + 60 > pageHeight - margin){
				doc.addPage();
				y = margin + 40;
			}
			
			// Texto antes del QR (centrado)
			doc.setFont(undefined, 'bold');
			doc.setFontSize(12);
			const qrText = 'Escanea el código QR para ver el estado de tu orden:';
			const qrTextWidth = doc.getTextWidth(qrText);
			doc.text(qrText, centerX - qrTextWidth/2, y);
			y += 20;
			
			// QR centrado
			const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(publicLink)}`;
			
			try {
				const img = await loadImageFromUrl(qrUrl);
				doc.addImage(img, 'PNG', centerX - qrSize/2, y, qrSize, qrSize);
				y += qrSize + 15;
			} catch(err) {
				console.error('Error generando QR:', err);
				doc.setFontSize(9);
				const errorText = 'No se pudo generar el código QR.';
				const errorTextWidth = doc.getTextWidth(errorText);
				doc.text(errorText, centerX - errorTextWidth/2, y + 20);
				y += 40;
			}
			
			// URL debajo del QR (centrada y dividida en líneas)
			doc.setFontSize(8);
			doc.setFont(undefined, 'normal');
			const visitText = 'O visita:';
			const visitTextWidth = doc.getTextWidth(visitText);
			doc.text(visitText, centerX - visitTextWidth/2, y);
			y += 12;
			
			doc.setFontSize(7);
			const urlLines = wrapText(publicLink, 60);
			if(Array.isArray(urlLines)){
				urlLines.forEach(line => {
					const lineWidth = doc.getTextWidth(line);
					doc.text(line, centerX - lineWidth/2, y);
					y += 10;
				});
			} else {
				const lineWidth = doc.getTextWidth(urlLines);
				doc.text(urlLines, centerX - lineWidth/2, y);
			}
			
			// Footer
			y = pageHeight - margin;
			doc.setFontSize(8);
			doc.setFont(undefined, 'italic');
			const footerText = 'Mipc Computadores - Servicio Técnico Especializado';
			const footerWidth = doc.getTextWidth(footerText);
			doc.text(footerText, centerX - footerWidth/2, y);

			doc.save(`orden_${order.id}.pdf`);

			function wrapText(text, maxChars){
				if(!text) return '';
				if(text.length <= maxChars) return text;
				const words = text.split(' ');
				const lines = [];
				let currentLine = '';
				
				words.forEach(word => {
					if((currentLine + word).length <= maxChars){
						currentLine += (currentLine ? ' ' : '') + word;
					} else {
						if(currentLine) lines.push(currentLine);
						currentLine = word;
					}
				});
				
				if(currentLine) lines.push(currentLine);
				return lines;
			}
		}

		// Función helper para cargar imagen desde URL
		function loadImageFromUrl(url){
			return new Promise((resolve, reject) => {
				const img = new Image();
				img.crossOrigin = 'Anonymous';
				img.onload = () => {
					const canvas = document.createElement('canvas');
					canvas.width = img.width;
					canvas.height = img.height;
					const ctx = canvas.getContext('2d');
					ctx.drawImage(img, 0, 0);
					resolve(canvas.toDataURL('image/png'));
				};
				img.onerror = reject;
				img.src = url;
			});
		}

		async function openOrderModal(id){
			editingOrderId = id || null;
			const modal = $('#modal-order');
			$('#modal-order-title').textContent = id ? 'Editar orden' : 'Nueva orden';
			const form = $('#form-order');
			form.reset();
			await populateClientSelect();
			// limpiar imágenes previas
			currentOrderImages = [];
			$('#image-preview-container').innerHTML = '';
			$('#order-images').value = '';

			if(id){
				const item = (await loadOrders()).find(x=>x.id==id);
				if(item){
					form.clientId.value = item.clientId || '';
					form.brand.value = item.brand || '';
					form.serial.value = item.serial || '';
					form.model.value = item.model || '';
					form.accessories.value = item.accessories || '';
					form.failure.value = item.failure || '';
					form.technician.value = item.technician || '';
					form.price.value = item.price || '';
					form.notes.value = item.notes || '';
					form.status.value = item.status || 'ingresado';
					form.paid.value = item.paid ? 'true' : 'false';
					// cargar imágenes existentes
					if(item.images && Array.isArray(item.images)){
						currentOrderImages = [...item.images];
						renderImagePreviews();
					}
				}
			}
			modal.classList.add('show');
			form.querySelector('select[name="clientId"]').focus();
		}
		function closeModal(sel){ document.querySelector(sel).classList.remove('show'); editingOrderId = null; editingClientId = null; }

		// nueva variable global para almacenar imágenes temporalmente
		let currentOrderImages = [];

		// nueva función: manejar carga de imágenes
		function handleImageUpload(e){
			const files = Array.from(e.target.files);
			if(files.length === 0) return;
			
			files.forEach(file => {
				if(!file.type.startsWith('image/')) return;
				
				// limitar tamaño (máx 2MB por imagen)
				if(file.size > 2 * 1024 * 1024){
					alert(`La imagen ${file.name} es muy grande. Máximo 2MB por imagen.`);
					return;
				}

				const reader = new FileReader();
				reader.onload = (ev) => {
					currentOrderImages.push({
						data: ev.target.result,
						name: file.name,
						date: new Date().toISOString()
					});
					renderImagePreviews();
				};
				reader.readAsDataURL(file);
			});
			
			// limpiar input para permitir seleccionar las mismas imágenes nuevamente
			e.target.value = '';
		}

		// nueva función: renderizar vista previa de imágenes
		function renderImagePreviews(){
			const container = $('#image-preview-container');
			container.innerHTML = '';
			
			currentOrderImages.forEach((img, index) => {
				const div = document.createElement('div');
				div.className = 'image-preview';
				div.innerHTML = `
					<img src="${img.data}" alt="${escapeHtml(img.name)}">
					<button type="button" class="remove-img" data-index="${index}">✕</button>
				`;
				container.appendChild(div);
			});

			// actualizar contador de imágenes
			const countEl = $('#image-count');
			if(countEl){
				const count = currentOrderImages.length;
				countEl.textContent = `(${count} ${count === 1 ? 'imagen' : 'imágenes'})`;
			}

			// bind eliminar imagen
			$$('.remove-img').forEach(btn => {
				btn.onclick = () => {
					const index = parseInt(btn.dataset.index);
					currentOrderImages.splice(index, 1);
					renderImagePreviews();
				};
			});
		}

		async function saveOrderFromForm(e){
			e.preventDefault();
			const f = e.target;
			const list = await loadOrders();
			if(editingOrderId){
				const idx = list.findIndex(x=>x.id==editingOrderId);
				if(idx>-1){
					list[idx] = {
						...list[idx],
						clientId: f.clientId.value,
						brand: f.brand.value,
						serial: f.serial.value,
						model: f.model.value,
						accessories: f.accessories.value,
						failure: f.failure.value,
						technician: f.technician.value,
						price: f.price.value || null,
						notes: f.notes.value,
						status: f.status ? f.status.value || f.status : (list[idx].status || 'ingresado'),
						paid: f.paid.value === 'true',
						images: currentOrderImages
					};
					await upsertEquipmentFromOrder(list[idx]);
				}
			} else {
				const item = {
					id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
					accessToken: generateAccessToken(),
					clientId: f.clientId.value,
					brand: f.brand.value,
					serial: f.serial.value,
					model: f.model.value,
					accessories: f.accessories.value,
					failure: f.failure.value,
					technician: f.technician.value,
					price: f.price.value || null,
					notes: f.notes.value,
					status: f.status ? f.status.value || 'ingresado' : 'ingresado',
					paid: f.paid.value === 'true',
					date: new Date().toISOString(),
					images: currentOrderImages
				};
				list.unshift(item);
				await upsertEquipmentFromOrder(item);
			}
			await saveOrders(list);
			closeModal('#modal-order');
			await renderOrders();
		}

		// nueva función: actualizar estado rápidamente
		async function updateOrderStatus(id, newStatus){
			const list = await loadOrders();
			const idx = list.findIndex(x=>x.id==id);
			if(idx===-1) return;
			
			// Asegurar que la orden tiene token antes de actualizar
			if(!list[idx].accessToken){
				list[idx].accessToken = generateAccessToken();
			}
			
			list[idx].status = newStatus;
			await upsertEquipmentFromOrder({...list[idx], date: new Date().toISOString()});
			await saveOrders(list);
			await renderOrders();
		}

		// Clients (ahora asíncrono)
		async function renderClients(){
			const tbody = $('#clients-table tbody');
			const items = await loadClients();
			tbody.innerHTML = '';
			items.forEach(c=>{
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td>${c.id}</td>
					<td>${escapeHtml(c.name)}</td>
					<td>${escapeHtml(c.cedula||'')}</td>
					<td>${escapeHtml(c.phone||'')}</td>
					<td>${escapeHtml(c.email||'')}</td>
					<td>
						<button class="btn btn-edit" data-id="${c.id}">Editar</button>
						<button class="btn btn-delete" data-id="${c.id}">Eliminar</button>
					</td>
				`;
				tbody.appendChild(tr);
			});
			$$('#clients-table .btn-edit').forEach(b=>b.onclick = ()=> openClientModal(b.dataset.id));
			$$('#clients-table .btn-delete').forEach(b=>b.onclick = async ()=> { if(confirm('Eliminar cliente?')) await deleteClient(b.dataset.id) });
			// actualizar métricas al renderizar clientes
			await computeMetrics();
		}

		async function openClientModal(id){
			editingClientId = id || null;
			const modal = $('#modal-client');
			$('#modal-client-title').textContent = id ? 'Editar cliente' : 'Nuevo cliente';
			const form = $('#form-client');
			form.reset();
			if(id){
				const item = (await loadClients()).find(x=>x.id==id);
				if(item){
					form.name.value = item.name || '';
					form.cedula.value = item.cedula || '';
					form.phone.value = item.phone || '';
					form.email.value = item.email || '';
					form.address.value = item.address || '';
				}
			}
			modal.classList.add('show');
		}

		async function saveClientFromForm(e){
			e.preventDefault();
			const f = e.target;
			const list = await loadClients();
			let newClientId = null;
			if(editingClientId){
				const idx = list.findIndex(x=>x.id==editingClientId);
				if(idx>-1){
					list[idx] = {...list[idx],
						name:f.name.value,
						cedula: f.cedula.value,
						phone:f.phone.value,
						email:f.email.value,
						address:f.address.value
					};
				}
			} else {
				const item = {
					id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
					name:f.name.value,
					cedula: f.cedula.value,
					phone:f.phone.value,
					email:f.email.value,
					address:f.address.value
				};
				list.unshift(item);
				newClientId = item.id;
			}
			await saveClients(list);

			// repoblar select de clientes en el formulario de orden
			await populateClientSelect();

			// si creamos un cliente nuevo, seleccionarlo automáticamente en el formulario de orden (si existe)
			if(newClientId){
				const orderSel = document.querySelector('#form-order select[name="clientId"]');
				if(orderSel){
					orderSel.value = newClientId;
					const modalOrder = document.querySelector('#modal-order');
					if(modalOrder && modalOrder.classList.contains('show')) orderSel.focus();
				}
			}

			closeModal('#modal-client');
			await renderClients();
		}

		async function deleteClient(id){
			const list = (await loadClients()).filter(x=>x.id!=id);
			await saveClients(list);
			await renderClients();
			// repoblar select de clientes
			await populateClientSelect();
		}

		// Helpers para clientes
		async function populateClientSelect(){
			const sel = document.querySelector('#form-order select[name="clientId"]');
			const clients = await loadClients();
			if(!sel) return;
			sel.innerHTML = '<option value="">-- Seleccionar cliente --</option>';
			clients.forEach(c => {
				const opt = document.createElement('option');
				opt.value = c.id; opt.textContent = c.name;
				sel.appendChild(opt);
			});
		}
		async function findClientById(id){ const clients = await loadClients(); return clients.find(c=>c.id==id); }

		// Equipments: hoja de vida por serial (asíncrono)
		async function upsertEquipmentFromOrder(order){
			if(!order.serial) return;
			const list = await loadEquipments();
			let eq = list.find(e => e.serial && e.serial.toLowerCase() === order.serial.toLowerCase());
			const entry = {
				orderId: order.id,
				date: order.date || new Date().toISOString(),
				clientId: order.clientId,
				brand: order.brand,
				model: order.model,
				accessories: order.accessories,
				failure: order.failure,
				technician: order.technician,
				notes: order.notes,
				status: order.status || 'ingresado'
			};
			if(eq){
				eq.brand = order.brand || eq.brand;
				eq.model = order.model || eq.model;
				eq.clientId = order.clientId || eq.clientId;
				eq.history = eq.history || [];
				eq.history.unshift(entry);
			} else {
				eq = {
					id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
					serial: order.serial,
					brand: order.brand,
					model: order.model,
					clientId: order.clientId,
					history: [entry]
				};
				list.unshift(eq);
			}
			await saveEquipments(list);
		}

		// Export / Import (ahora usan el backend)
		async function exportData(){
			const data = { orders: await loadOrders(), clients: await loadClients(), equipments: await loadEquipments(), transactions: await loadTransactions(), exportedAt: new Date().toISOString() };
			const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url; a.download = 'mipc_data.json'; a.click();
			URL.revokeObjectURL(url);
		}
		async function importDataFile(e){
			const file = e.target.files[0];
			if(!file) return;
			const reader = new FileReader();
			reader.onload = async ev => {
				try {
					const data = JSON.parse(ev.target.result);
					if(Array.isArray(data.orders)) await saveOrders(data.orders);
					if(Array.isArray(data.clients)) await saveClients(data.clients);
					if(Array.isArray(data.equipments)) await saveEquipments(data.equipments);
					if(Array.isArray(data.transactions)) await saveTransactions(data.transactions);
					alert('Importación completada');
					await renderOrders(); await renderClients();
					await populateFinanceCategorySelects();
					await renderFinance();
				} catch(err){
					alert('Archivo inválido');
				}
			};
			reader.readAsText(file);
			e.target.value = '';
		}

		// Exportar órdenes a PDF (usa jsPDF) - ahora async para obtener datos
		async function exportOrdersPDF(){
			const orders = await loadOrders();
			if(!orders || orders.length===0) return alert('No hay órdenes para exportar.');
			const clients = await loadClients();
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({unit:'pt', format:'letter'});
			const margin = 40;
			let y = 40;
			const lineHeight = 14;
			const pageHeight = doc.internal.pageSize.height;
			const pageWidth = doc.internal.pageSize.width;
			
			doc.setFontSize(14);
			doc.text('Órdenes - Mipc Computadores', margin, y);
			y += 20;
			doc.setFontSize(10);

			const cols = ['ID','Cliente','Marca','Modelo','Serie','Estado','Pago','Técnico','Fecha'];
			const colWidths = [40,100,60,60,80,70,50,80,80];
			const startX = margin;

			function printRow(values){
				let x = startX;
				for(let i=0;i<values.length;i++){
					const txt = (values[i]===null||values[i]===undefined)?'':String(values[i]);
					doc.text(truncateText(txt, Math.floor(colWidths[i]/6)), x, y);
					x += colWidths[i];
				}
				y += lineHeight;
			}

			printRow(cols);
			doc.setLineWidth(0.5);
			doc.line(margin, y-8, pageWidth - margin, y-8);

			orders.forEach((o, idx)=>{
				const client = clients.find(c=>c.id==o.clientId) || {name:'--'};
				const statusLabel = ORDER_STATUSES[o.status || 'ingresado'] || (o.status||'');
				const paymentLabel = o.paid ? 'Sí' : 'No';
				const row = [
					o.id,
					client.name,
					o.brand || '',
					o.model || '',
					o.serial || '',
					statusLabel,
					paymentLabel,
					o.technician || '',
					o.date ? new Date(o.date).toLocaleString() : ''
				];
				if(y + lineHeight > pageHeight - margin){
					doc.addPage();
					y = margin;
				}
				printRow(row);
			});

			doc.save('ordenes_mipc.pdf');

			function truncateText(str, maxChars){
				if(!str) return '';
				if(str.length <= maxChars) return str;
				return str.slice(0, maxChars-3) + '...';
			}
		}

		// NUEVO: procesar inventario y finanzas de factura
		async function processInvoiceInventoryAndFinance(invoice){
			const inventory = await loadInventory();
			
			// descontar inventario
			for(const item of invoice.items){
				if(item.inventoryItemId){
					const idx = inventory.findIndex(i => i.id === item.inventoryItemId);
					if(idx !== -1){
						inventory[idx].stock = Number(inventory[idx].stock || 0) - Number(item.quantity || 0);
						inventory[idx].updatedAt = new Date().toISOString();
					}
				}
			}
			await saveInventory(inventory);

			// registrar movimientos de inventario
			const movements = await loadInventoryMovements();
			for(const item of invoice.items){
				if(item.inventoryItemId){
					movements.unshift({
						id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
						itemId: item.inventoryItemId,
						type: 'out',
						qty: item.quantity,
						unitPrice: item.unitPrice,
						total: item.total,
						date: invoice.date,
						notes: `Factura ${invoice.invoiceNumber}`,
						invoiceId: invoice.id
					});
				}
			}
			await saveInventoryMovements(movements);

			// registrar en finanzas si está pagada
			if(invoice.paymentStatus === 'paid'){
				const transactions = await loadTransactions();
				transactions.unshift({
					id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
					type: 'income',
					amount: invoice.total,
					category: 'Ventas',
					date: invoice.date,
					notes: `Factura ${invoice.invoiceNumber}`,
					invoiceId: invoice.id
				});
				await saveTransactions(transactions);
			}
		}

		/* NUEVO: eliminar factura */
		async function deleteInvoice(id){
			const invoices = await loadInvoices();
			const invoice = invoices.find(i => i.id === id);
			
			if(invoice){
				// restaurar inventario
				const inventory = await loadInventory();
				for(const item of invoice.items){
					if(item.inventoryItemId){
						const idx = inventory.findIndex(i => i.id === item.inventoryItemId);
						if(idx !== -1){
							inventory[idx].stock = Number(inventory[idx].stock || 0) + Number(item.quantity || 0);
							inventory[idx].updatedAt = new Date().toISOString();
						}
					}
				}
				await saveInventory(inventory);

				// eliminar movimientos
				let movements = await loadInventoryMovements();
				movements = movements.filter(m => m.invoiceId !== id);
				await saveInventoryMovements(movements);

				// eliminar transacción
				let transactions = await loadTransactions();
				transactions = transactions.filter(t => t.invoiceId !== id);
				await saveTransactions(transactions);
			}

			const list = invoices.filter(x => x.id !== id);
			await saveInvoices(list);
			await renderInvoices();
			await renderInventory();
			await renderFinance();
		}

		/* NUEVO: exportar factura a PDF */
		async function exportInvoicePDF(id){
			const invoices = await loadInvoices();
			const invoice = invoices.find(i => i.id === id);
			if(!invoice) return alert('Factura no encontrada');

			const clients = await loadClients();
			const client = clients.find(c => c.id === invoice.clientId) || {name:'--', cedula:'', phone:'', email:'', address:''};

			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({unit:'pt', format:'letter'});
			const pageWidth = doc.internal.pageSize.width;
			const margin = 40;
			const centerX = pageWidth / 2;
			let y = 40;

			// Logo
			try {
				const logoImage = await loadImageFromUrl('./image.png');
				const logoSize = 50;
				doc.addImage(logoImage, 'PNG', margin, y, logoSize, logoSize);
			} catch(err) {
				console.error('Error cargando logo:', err);
			}

			// Título y número de factura
			doc.setFontSize(20);
			doc.setFont(undefined, 'bold');
			doc.text('FACTURA', pageWidth - margin - 100, y + 20);
			doc.setFontSize(12);
			doc.setFont(undefined, 'normal');
			doc.text(invoice.invoiceNumber || '', pageWidth - margin - 100, y + 40);

			y += 70;

			// Información de la empresa (izquierda)
			doc.setFontSize(10);
			doc.setFont(undefined, 'bold');
			doc.text('MIPC COMPUTADORES', margin, y);
			y += 15;
			doc.setFont(undefined, 'normal');
			doc.text('NIT: 900.XXX.XXX-X', margin, y);
			y += 12;
			doc.text('Tel: 300 XXX XXXX', margin, y);
			y += 12;
			doc.text('Email: info@mipc.com', margin, y);

			// Información del cliente (derecha)
			y = 110;
			const rightX = centerX + 20;
			doc.setFont(undefined, 'bold');
			doc.text('CLIENTE:', rightX, y);
			y += 15;
			doc.setFont(undefined, 'normal');
			doc.text(client.name, rightX, y);
			y += 12;
			if(client.cedula) { doc.text(`Cédula: ${client.cedula}`, rightX, y); y += 12; }
			if(client.phone) { doc.text(`Tel: ${client.phone}`, rightX, y); y += 12; }
			if(client.email) { doc.text(`Email: ${client.email}`, rightX, y); y += 12; }

			y = Math.max(y, 180) + 20;

			// Fecha
			doc.setFont(undefined, 'bold');
			doc.text(`Fecha: `, margin, y);
			doc.setFont(undefined, 'normal');
			doc.text(invoice.date || '', margin + 50, y);

			y += 30;

			// Línea separadora
			doc.setLineWidth(1);
			doc.line(margin, y, pageWidth - margin, y);
			y += 20;

			// Tabla de ítems
			doc.setFontSize(9);
			doc.setFont(undefined, 'bold');
			
			const colX = [margin, margin + 250, margin + 320, margin + 400, margin + 480];
			doc.text('Descripción', colX[0], y);
			doc.text('Cant.', colX[1], y);
			doc.text('Precio u.', colX[2], y);
			doc.text('Total', colX[3], y);
			
			y += 15;
			doc.setLineWidth(0.5);
			doc.line(margin, y - 5, pageWidth - margin, y - 5);
			
			doc.setFont(undefined, 'normal');
			
			invoice.items.forEach(item => {
				if(y > 700){
					doc.addPage();
					y = 40;
				}
				
				doc.text(item.description || '', colX[0], y, {maxWidth: 240});
				doc.text(String(item.quantity || 0), colX[1], y);
				doc.text(formatCurrency(item.unitPrice || 0), colX[2], y);
				doc.text(formatCurrency(item.total || 0), colX[3], y);
				
				y += 20;
			});

			y += 10;
			doc.line(margin, y, pageWidth - margin, y);
			y += 20;

			// Totales
			const totalsX = pageWidth - margin - 150;
			doc.setFont(undefined, 'normal');
			doc.text('Subtotal:', totalsX, y);
			doc.text(formatCurrency(invoice.subtotal || 0), totalsX + 80, y, {align: 'right'});
			y += 15;
			
			doc.text('IVA (19%):', totalsX, y);
			doc.text(formatCurrency(invoice.tax || 0), totalsX + 80, y, {align: 'right'});
			y += 15;
			
			doc.setFont(undefined, 'bold');
			doc.setFontSize(11);
			doc.text('TOTAL:', totalsX, y);
			doc.text(formatCurrency(invoice.total || 0), totalsX + 80, y, {align: 'right'});

			// Notas
			if(invoice.notes){
				y += 30;
				doc.setFontSize(9);
				doc.setFont(undefined, 'bold');
				doc.text('Notas:', margin, y);
				y += 12;
				doc.setFont(undefined, 'normal');
				const notesLines = doc.splitTextToSize(invoice.notes, pageWidth - margin * 2);
				doc.text(notesLines, margin, y);
			}

			// Footer
			y = 750;
			doc.setFontSize(8);
			doc.setFont(undefined, 'italic');
			const footerText = 'Gracias por su compra - Mipc Computadores';
			const footerWidth = doc.getTextWidth(footerText);
			doc.text(footerText, centerX - footerWidth/2, y);

			doc.save(`factura_${invoice.invoiceNumber}.pdf`);
		}

		// helpers
		function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

		// Modal: ver hoja de vida del equipo
		async function openEquipmentModal(serial){
			const modal = $('#modal-equipment');
			$('#modal-equipment-title').textContent = `Hoja de vida - ${serial}`;
			const container = $('#equipment-history');
			container.innerHTML = '';
			const list = await loadEquipments();
			const eq = list.find(e => e.serial && e.serial.toLowerCase() === serial.toLowerCase());
			if(!eq){
				container.innerHTML = '<div class="history-item">No hay historial para este número de serie.</div>';
			} else {
				eq.history = eq.history || [];
				eq.history.forEach(h=>{
					const client = (async ()=> { const c = await findClientById(h.clientId); return c || {name:'--'}; })();
					// para simplicidad mostramos cliente por id si existe (carga ya asíncrona)
					const clientSync = (function(){ /* placeholder */ })();
					const div = document.createElement('div');
					div.className = 'history-item';
					div.innerHTML = `<strong>${new Date(h.date).toLocaleString()}</strong> — ${escapeHtml(h.status||'')} — ${escapeHtml(h.failure||'')}<br><span class="small">Cliente: ${escapeHtml(((findClientById(h.clientId)||{}).name)||'--')} — Técnico: ${escapeHtml(h.technician||'')}</span>`;
					container.appendChild(div);
				});
			}
			modal.classList.add('show');
		}

		// Generar link de WhatsApp para una orden
		async function generateWhatsAppLink(order){
			const client = await findClientById(order.clientId) || {};
			let phone = client.phone || '';
			const normalized = normalizePhone(phone);
			if(!normalized){
				alert('Teléfono del cliente no disponible para enviar WhatsApp.');
				return null;
			}
			const name = client.name || 'cliente';
			const brand = order.brand || '';
			const model = order.model || '';
			const serial = order.serial || '';
			const technician = order.technician || '';
			const status = order.status || 'ingresado';
			
			// Asegurar que la orden tiene token antes de generar el enlace
			if(!order.accessToken){
				order.accessToken = generateAccessToken();
			}
			const publicLink = getPublicOrderLink(order);

			let msg = '';
			switch(status){
				case 'en_reparacion':
					msg = `Hola ${name}, te informamos que tu equipo (${brand} ${model}, S/N: ${serial}) está en reparación. Nuestro técnico ${technician || 'asignado'} está trabajando en la evaluación y reparación. Te avisaremos cuando haya novedades.\n\nPuedes ver el estado de tu orden aquí: ${publicLink}`;
					break;
				case 'espera_entrega':
					msg = `Hola ${name}, tu equipo (${brand} ${model}, S/N: ${serial}) ya está listo y en espera de entrega en nuestro taller. Por favor pasa a recogerlo. Si necesitas coordinar la entrega, responde este mensaje.\n\nVer detalles: ${publicLink}`;
					break;
				case 'entregado':
					msg = `Hola ${name}, confirmamos que tu equipo (${brand} ${model}, S/N: ${serial}) ha sido entregado. Muchas gracias por confiar en Mipc Computadores. Si tienes alguna inquietud, contáctanos.\n\nVer detalles: ${publicLink}`;
					break;
				case 'ingresado':
				default:
					msg = `Hola ${name}, tu equipo (${brand} ${model}, S/N: ${serial}) ha sido ingresado a nuestro taller. Puedes ver los detalles y seguimiento aquí: ${publicLink}. Pronto te informaremos sobre el estado.`;
					break;
			}

			msg = `${msg}\n\n— Mipc Computadores`;

			return `https://api.whatsapp.com/send?phone=${normalized}&text=${encodeURIComponent(msg)}&type=phone_number&app_absent=0`;
		}

		// Normaliza teléfono
		function normalizePhone(phone){
			phone = (phone||'').replace(/\D/g,'');
			if(!phone) return null;
			// eliminar ceros iniciales
			phone = phone.replace(/^0+/, '');
			// si no empieza con 57, agregarlo
			if(!phone.startsWith('57')) phone = '57' + phone;
			return phone;
		}

		// Finanzas: renderizado de transacciones (asíncrono)
		async function renderFinance(){
			const tbody = $('#transactions-table tbody');
			const items = await loadTransactions();
			tbody.innerHTML = '';
			let totalIncome = 0, totalExpense = 0;
			const typeFilter = ($('#type-filter') && $('#type-filter').value) || '';
			const categoryFilter = ($('#category-filter') && $('#category-filter').value) || '';
			const filtered = items.filter(t=>{
				if(typeFilter && t.type !== typeFilter) return false;
				if(categoryFilter && t.category !== categoryFilter) return false;
				return true;
			});
			filtered.forEach(t=>{
				if(t.type==='income') totalIncome += Number(t.amount||0);
				else totalExpense += Number(t.amount||0);
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td>${t.id}</td>
					<td>${t.type==='income'?'Ingreso':'Gasto'}</td>
					<td>${formatCurrency(Number(t.amount||0))}</td>
					<td>${escapeHtml(t.category||'')}</td>
					<td>${t.date || ''}</td>
					<td>${escapeHtml(t.notes||'')}</td>
					<td>
						<button class="btn btn-delete" data-id="${t.id}">Eliminar</button>
					</td>
				`;
				tbody.appendChild(tr);
			});
			$$('#transactions-table .btn-delete').forEach(b=> b.onclick = async ()=> { if(confirm('Eliminar transacción?')) await deleteTransaction(b.dataset.id) });
			const summary = $('#finance-summary');
			const balance = totalIncome - totalExpense;
			if(summary) summary.textContent = `Ingresos: ${formatCurrency(totalIncome)} — Gastos: ${formatCurrency(totalExpense)} — Saldo: ${formatCurrency(balance)}`;
			await computeMetrics();
		}

		async function saveTransactionFromForm(e){
			e.preventDefault();
			const f = e.target;
			const list = await loadTransactions();
			const item = {
				id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
				type: f.type.value,
				amount: Number(f.amount.value || 0),
				category: f.category.value,
				date: f.date.value || new Date().toISOString().slice(0,10),
				notes: f.notes.value
			};
			list.unshift(item);
			await saveTransactions(list);
			// actualizar selects en caso de nueva categoría
			await populateFinanceCategorySelects();
			f.reset();
			await renderFinance();
		}

		async function deleteTransaction(id){
			const list = (await loadTransactions()).filter(x=>x.id!=id);
			await saveTransactions(list);
			// actualizar selects despues de eliminar
			await populateFinanceCategorySelects();
			await renderFinance();
		}

		/* ===================== INVENTARIO ===================== */
		// Renderizar tabla de inventario
		async function renderInventory(){
			const tbody = document.querySelector('#inventory-table tbody');
			if(!tbody) return;
			const list = await loadInventory();
			const filter = (document.getElementById('inv-filter')?.value || '').toLowerCase().trim();
			const filtered = list.filter(i=>{
				if(!filter) return true;
				return [i.name, i.category, i.supplier].filter(Boolean).join(' ').toLowerCase().includes(filter);
			});

			tbody.innerHTML = '';
			let totalUnits = 0;
			let totalValue = 0;

			filtered.forEach(item=>{
				const stock = Number(item.stock||0);
				const unitCost = Number(item.unitCost||0);
				const unitPrice = Number(item.unitPrice||0);
				totalUnits += stock;
				totalValue += stock * unitCost;
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td>${item.id}</td>
					<td>${escapeHtml(item.name||'')}</td>
					<td><span class="badge-cat">${escapeHtml(item.category||'')}</span></td>
					<td>${stock}</td>
					<td>${unitCost?formatCurrency(unitCost):'--'}</td>
					<td>${unitPrice?formatCurrency(unitPrice):'--'}</td>
					<td>${escapeHtml(item.supplier||'')}</td>
					<td>${item.updatedAt ? new Date(item.updatedAt).toLocaleString() : ''}</td>
					<td class="actions">
						<button class="btn" data-id="${item.id}" data-act="in" title="Entrada" style="background:#7af0a5;color:#04121a">Entrada</button>
						<button class="btn" data-id="${item.id}" data-act="out" title="Salida" style="background:#ffcc33;color:#04121a">Salida</button>
						<button class="btn btn-edit" data-id="${item.id}" data-act="edit">Editar</button>
						<button class="btn btn-delete" data-id="${item.id}" data-act="del">Eliminar</button>
						<button class="btn" data-id="${item.id}" data-act="hist" style="background:#3bb4ff;color:#04121a">Historial</button>
					</td>
				`;
				tbody.appendChild(tr);
			});

			// resumen
			const sum = document.getElementById('inventory-summary');
			if(sum) sum.textContent = `Ítems: ${filtered.length} — Unidades: ${totalUnits} — Valor (costo): ${formatCurrency(totalValue)}`;

			// acciones
			tbody.querySelectorAll('button').forEach(btn=>{
				const id = btn.getAttribute('data-id');
				const act = btn.getAttribute('data-act');
				if(act==='edit') btn.onclick = ()=> openInventoryItemModal(id);
				if(act==='del') btn.onclick = async ()=> { if(confirm('Eliminar ítem?')) await deleteInventoryItem(id); };
				if(act==='in') btn.onclick = ()=> openMovementModal(id, 'in');
				if(act==='out') btn.onclick = ()=> openMovementModal(id, 'out');
				if(act==='hist') btn.onclick = ()=> openMovementsHistory(id);
			});
		}

		// Abrir modal para crear/editar ítem
		async function openInventoryItemModal(id){
			editingItemId = id || null;
			const modal = document.getElementById('modal-inventory-item');
			const form = document.getElementById('form-inventory-item');
			document.getElementById('modal-inventory-title').textContent = id ? 'Editar ítem' : 'Nuevo ítem';
			form.reset();
			if(id){
				const list = await loadInventory();
				const it = list.find(x=>x.id===id);
				if(it){
					form.name.value = it.name || '';
					form.category.value = it.category || '';
					form.stock.value = Number(it.stock||0);
					form.unitCost.value = it.unitCost ?? '';
					form.unitPrice.value = it.unitPrice ?? '';
					form.supplier.value = it.supplier || '';
					form.notes.value = it.notes || '';
				}
			}
			modal.classList.add('show');
		}

		// Guardar ítem (crear/editar)
		async function saveInventoryItemFromForm(e){
			e.preventDefault();
			const f = e.target;
			const list = await loadInventory();
			const payload = {
				name: f.name.value,
				category: f.category.value,
				stock: Number(f.stock.value||0),
				unitCost: f.unitCost.value ? Number(f.unitCost.value) : null,
				unitPrice: f.unitPrice.value ? Number(f.unitPrice.value) : null,
				supplier: f.supplier.value,
				notes: f.notes.value,
				updatedAt: new Date().toISOString()
			};
			if(editingItemId){
				const idx = list.findIndex(x=>x.id===editingItemId);
				if(idx>-1){ list[idx] = {...list[idx], ...payload}; }
			} else {
				list.unshift({
					id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
					createdAt: new Date().toISOString(),
					...payload
				});
			}
			await saveInventory(list);
			closeModal('#modal-inventory-item');
			await renderInventory();
		}

		// Eliminar ítem de inventario
		async function deleteInventoryItem(id){
			const list = await loadInventory();
			const newList = list.filter(x=>x.id!==id);
			await saveInventory(newList);
			// eliminar movimientos asociados
			let movs = await loadInventoryMovements();
			movs = movs.filter(m => m.itemId !== id);
			await saveInventoryMovements(movs);
			await renderInventory();
		}

		// Abrir modal de movimiento (entrada/salida)
		async function openMovementModal(itemId, type){
			currentMovementItemId = itemId;
			currentMovementType = type; // 'in' | 'out'
			const modal = document.getElementById('modal-movement');
			const form = document.getElementById('form-movement');
			form.reset();
			form.itemId.value = itemId;
			form.type.value = type;
			const today = new Date().toISOString().slice(0,10);
			form.date.value = today;
			const list = await loadInventory();
			const it = list.find(x=>x.id===itemId) || {};
			document.getElementById('modal-movement-title').textContent = type==='in' ? `Entrada — ${it.name||''}` : `Salida — ${it.name||''}`;
			const hint = document.getElementById('movement-hint');
			if(hint){
				const stock = Number(it.stock||0);
				const txt = type==='in'
					? `Stock actual: ${stock}. Usa "Valor unitario" como costo de compra.`
					: `Stock actual: ${stock}. No puedes retirar más de ${stock}. Usa "Valor unitario" como precio de salida si aplica.`;
				hint.textContent = txt;
			}
			modal.classList.add('show');
		}

		// Guardar movimiento
		async function saveMovementFromForm(e){
			e.preventDefault();
			const f = e.target;
			const itemId = f.itemId.value;
			const type = f.type.value; // in | out
			const qty = Math.max(1, Number(f.qty.value||0));
			const unitValue = Number(f.unitValue.value||0);
			const date = f.date.value || new Date().toISOString().slice(0,10);
			const notes = f.notes.value || '';

			const inv = await loadInventory();
			const idx = inv.findIndex(x=>x.id===itemId);
			if(idx===-1) return alert('Ítem no encontrado');
			const currentStock = Number(inv[idx].stock||0);
			if(type==='out' && qty > currentStock){
				return alert('No hay suficiente stock para la salida.');
			}
			inv[idx].stock = type==='in' ? currentStock + qty : currentStock - qty;
			inv[idx].updatedAt = new Date().toISOString();
			await saveInventory(inv);

			const movs = await loadInventoryMovements();
			movs.unshift({
				id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
				itemId,
				type,
				qty,
				unitPrice: unitValue || null,
				total: unitValue ? unitValue * qty : null,
				date,
				notes
			});
			await saveInventoryMovements(movs);

			closeModal('#modal-movement');
			await renderInventory();
		}

		// Abrir historial de movimientos
		async function openMovementsHistory(itemId){
			const modal = document.getElementById('modal-movements-history');
			const list = await loadInventoryMovements();
			const filtered = list.filter(m => m.itemId === itemId);
			const container = document.getElementById('movements-history');
			container.innerHTML = '';
			if(filtered.length===0){
				container.textContent = 'Sin movimientos para este ítem.';
			} else {
				filtered.forEach(m => {
					const div = document.createElement('div');
					div.className = 'history-item';
					const sign = m.type==='in' ? '+' : '-';
					const label = m.type==='in' ? 'Entrada' : 'Salida';
					const uv = m.unitPrice ? formatCurrency(Number(m.unitPrice)) : '--';
					const tot = m.total ? formatCurrency(Number(m.total)) : '--';
					div.innerHTML = `<strong>${label}</strong> ${sign}${m.qty} u. — u:${uv} — total:${tot} — <span class="small">${m.date||''}</span><br><span class="small">${escapeHtml(m.notes||'')}</span>`;
					container.appendChild(div);
				});
			}
			modal.classList.add('show');
		}

		function formatCurrency(v){
			try {
				return new Intl.NumberFormat('es-CO', { style:'currency', currency:'COP', maximumFractionDigits:2 }).format(v);
			} catch(e){
				return (v||0).toFixed(2);
			}
		}

		// nuevas métricas (async)
		async function computeMetrics(){
			const tx = await loadTransactions();
			const orders = await loadOrders();
			const clients = await loadClients();
			let income = 0, expense = 0;
			tx.forEach(t => {
				if(t.type === 'income') income += Number(t.amount||0);
				else expense += Number(t.amount||0);
			});
			const balance = income - expense;
			const txCount = tx.length;
			const avgTx = txCount ? ((income + expense) / txCount) : 0;
			const statusCounts = {};
			Object.keys(ORDER_STATUSES).forEach(k => statusCounts[k] = 0);
			let paidOrders = 0, unpaidOrders = 0;
			orders.forEach(o => {
				const s = o.status || 'ingresado';
				statusCounts[s] = (statusCounts[s]||0) + 1;
				if(o.paid) paidOrders++;
				else unpaidOrders++;
			});
			const container = document.getElementById('finance-metrics');
			if(!container) return;
			container.innerHTML = `
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:140px">
					<div class="small">Ingresos</div>
					<div style="font-weight:700">${formatCurrency(income)}</div>
				</div>
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:140px">
					<div class="small">Gastos</div>
					<div style="font-weight:700">${formatCurrency(expense)}</div>
				</div>
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:140px">
					<div class="small">Saldo</div>
					<div style="font-weight:700">${formatCurrency(balance)}</div>
				</div>
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:140px">
					<div class="small">Transacciones</div>
					<div style="font-weight:700">${txCount}</div>
					<div class="small">Promedio: ${formatCurrency(avgTx)}</div>
				</div>
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:180px">
					<div class="small">Órdenes</div>
					<div style="font-weight:700">${orders.length}</div>
					<div class="small">Clientes: ${clients.length}</div>
					<div class="small">Pagadas: ${paidOrders} / No pagadas: ${unpaidOrders}</div>
				</div>
				<div style="background:#071b22;padding:10px;border-radius:8px;min-width:220px">
					<div class="small">Desglose por estado (órdenes)</div>
					<div style="font-weight:600;margin-top:6px">
						${Object.keys(ORDER_STATUSES).map(k => `${ORDER_STATUSES[k]}: ${statusCounts[k]||0}`).join(' — ')}
					</div>
				</div>
			`;
		}

		// nueva función: cambiar estado de pago (async)
		async function toggleOrderPayment(id){
			const list = await loadOrders();
			const idx = list.findIndex(x=>x.id==id);
			if(idx===-1) return;
			
			const order = list[idx];
			const wasPaid = order.paid;
			
			list[idx].paid = !wasPaid;
			await saveOrders(list);
			
			if(!wasPaid && list[idx].paid && order.price && Number(order.price) > 0){
				const client = (await loadClients()).find(c=>c.id==order.clientId) || {name:'Cliente'};
				const transactions = await loadTransactions();
				
				const transaction = {
					id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
					type: 'income',
					amount: Number(order.price),
					category: 'Servicios',
					date: new Date().toISOString().slice(0,10),
					notes: `Pago orden ${order.id} — ${client.name}`,
					orderId: order.id
				};
				
				transactions.unshift(transaction);
				await saveTransactions(transactions);
			}
			
			if(wasPaid && !list[idx].paid){
				let transactions = await loadTransactions();
				const initialCount = transactions.length;
				transactions = transactions.filter(t => {
					const linkedByOrderId = t.orderId && t.orderId === order.id;
					const linkedByNotes = t.notes && t.notes.includes(`orden ${order.id}`);
					return !(linkedByOrderId || linkedByNotes);
				});
				
				if(transactions.length < initialCount){
					await saveTransactions(transactions);
					console.log(`Transacción eliminada para orden ${order.id}`);
				}
			}
			
			await renderOrders();
			await renderFinance();
			await computeMetrics();
		}

		// nueva función: generar token de acceso aleatorio
		function generateAccessToken(){
			const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
			let token = '';
			for(let i = 0; i < 16; i++){
				token += chars.charAt(Math.floor(Math.random() * chars.length));
			}
			return token;
		}

		// nueva función: obtener enlace público de la orden
		function getPublicOrderLink(order){
			if(!order.accessToken){
				// si la orden no tiene token, generarlo (para órdenes antiguas)
				order.accessToken = generateAccessToken();
			}
			const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '');
			return `${baseUrl}orden.html?token=${order.accessToken}`;
		}

		// nueva función: copiar enlace público al portapapeles
		async function copyPublicLink(id){
			const orders = await loadOrders();
			const order = orders.find(o=>o.id==id);
			if(!order) return alert('Orden no encontrada');
			
			// generar token si no existe
			if(!order.accessToken){
				order.accessToken = generateAccessToken();
				await saveOrders(orders);
			}
			
			const link = getPublicOrderLink(order);
			
			try {
				await navigator.clipboard.writeText(link);
				alert('Enlace copiado al portapapeles:\n' + link);
			} catch(err){
				// fallback para navegadores que no soportan clipboard API
				const textarea = document.createElement('textarea');
				textarea.value = link;
				textarea.style.position = 'fixed';
				textarea.style.opacity = '0';
				document.body.appendChild(textarea);
				textarea.select();
				document.execCommand('copy');
				document.body.removeChild(textarea);
				alert('Enlace copiado al portapapeles:\n' + link);
			}
		}

		// Abrir WhatsApp para la orden (usa siempre el teléfono guardado en el cliente y prefijo 57)
		async function openWhatsApp(id){
			try {
				const orders = await loadOrders();
				const order = orders.find(o=>o.id==id);
				if(!order) return alert('Orden no encontrada');
				
				// generar token si no existe
				if(!order.accessToken){
					order.accessToken = generateAccessToken();
					// actualizar la orden en la lista y guardar
					const idx = orders.findIndex(x=>x.id==id);
					if(idx>-1){
					orders[idx] = order;
						await saveOrders(orders);
					}
				}
				
				const link = await generateWhatsAppLink(order);
				if(!link) return;
				window.open(link, '_blank');
			} catch(error) {
				console.error('Error en openWhatsApp:', error);
				alert('Error al generar el enlace de WhatsApp. Por favor, inténtalo de nuevo.');
			}
		}

		/* NUEVO: render de facturas */
		async function renderInvoices(){
			const tbody = document.querySelector('#invoices-table tbody');
			if(!tbody) return;
			const invoices = await loadInvoices();
			const clients = await loadClients();
			const filter = (document.getElementById('invoice-filter')?.value || '').toLowerCase().trim();
			
			const filtered = invoices.filter(inv=>{
				if(!filter) return true;
				const client = clients.find(c=>c.id===inv.clientId) || {};
				return [inv.invoiceNumber, client.name].join(' ').toLowerCase().includes(filter);
			});

			tbody.innerHTML = '';
			let totalAmount = 0;
			let paidCount = 0;

			filtered.forEach(inv=>{
				const client = clients.find(c=>c.id===inv.clientId) || {name:'--'};
				const subtotal = Number(inv.subtotal || 0);
				const tax = Number(inv.tax || 0);
				const total = Number(inv.total || 0);
				totalAmount += total;
				
				let statusBadge = '<span class="badge-status-unpaid">No pagada</span>';
				if(inv.paymentStatus === 'paid'){
					statusBadge = '<span class="badge-status-paid">Pagada</span>';
					paidCount++;
				} else if(inv.paymentStatus === 'partial'){
					statusBadge = '<span class="badge-status-partial">Pago parcial</span>';
				}

				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td><strong>${escapeHtml(inv.invoiceNumber||'')}</strong></td>
					<td>${escapeHtml(client.name)}</td>
					<td>${inv.date || ''}</td>
					<td>${formatCurrency(subtotal)}</td>
					<td>${formatCurrency(tax)}</td>
					<td><strong>${formatCurrency(total)}</strong></td>
					<td>${statusBadge}</td>
					<td class="actions">
						<button class="btn" data-id="${inv.id}" data-act="pdf" style="background:#7af0a5;color:#04121a">PDF</button>
						<button class="btn btn-edit" data-id="${inv.id}" data-act="edit">Editar</button>
						<button class="btn btn-delete" data-id="${inv.id}" data-act="del">Eliminar</button>
					</td>
				`;
				tbody.appendChild(tr);
			});

			const sum = document.getElementById('invoices-summary');
			if(sum) sum.textContent = `Facturas: ${filtered.length} — Pagadas: ${paidCount} — Total facturado: ${formatCurrency(totalAmount)}`;

			// acciones
			tbody.querySelectorAll('button').forEach(btn=>{
				const id = btn.getAttribute('data-id');
				const act = btn.getAttribute('data-act');
				if(act==='edit') btn.onclick = ()=> openInvoiceModal(id);
				if(act==='del') btn.onclick = async ()=> { if(confirm('Eliminar factura?')) await deleteInvoice(id); };
				if(act==='pdf') btn.onclick = async ()=> await exportInvoicePDF(id);
			});
		}

		/* NUEVO: abrir modal de factura */
		async function openInvoiceModal(id){
			editingInvoiceId = id || null;
			const modal = document.getElementById('modal-invoice');
			const form = document.getElementById('form-invoice');
			document.getElementById('modal-invoice-title').textContent = id ? 'Editar factura' : 'Nueva factura';
			
			form.reset();
			form.date.value = new Date().toISOString().slice(0,10);
			
			// poblar selector de clientes
			const clientSelect = form.querySelector('select[name="clientId"]');
			const clients = await loadClients();
			clientSelect.innerHTML = '<option value="">-- Seleccionar cliente --</option>';
			clients.forEach(c => {
				const opt = document.createElement('option');
				opt.value = c.id;
				opt.textContent = c.name;
				clientSelect.appendChild(opt);
			});

			if(id){
				const invoices = await loadInvoices();
				const inv = invoices.find(x=>x.id==id);
				if(inv){
					form.clientId.value = inv.clientId || '';
					form.invoiceNumber.value = inv.invoiceNumber || '';
					form.date.value = inv.date || '';
					form.paymentStatus.value = inv.paymentStatus || 'unpaid';
					form.notes.value = inv.notes || '';
					invoiceItems = inv.items ? [...inv.items] : [];
				}
			} else {
				// generar número de factura
				const invoices = await loadInvoices();
				const lastNumber = invoices.length > 0 ? Math.max(...invoices.map(i => {
					const num = i.invoiceNumber ? parseInt(i.invoiceNumber.replace(/\D/g, '')) : 0;
					return isNaN(num) ? 0 : num;
				})) : 0;
				form.invoiceNumber.value = `FAC-${String(lastNumber + 1).padStart(6, '0')}`;
				invoiceItems = [];
			}

			renderInvoiceItems();
			modal.classList.add('show');
		}

		/* NUEVO: agregar fila de ítem */
		function addInvoiceItemRow(){
			invoiceItems.push({
				id: Date.now().toString(),
				description: '',
				inventoryItemId: '',
				quantity: 1,
				unitPrice: 0,
				total: 0
			});
			renderInvoiceItems();
		}

		/* NUEVO: renderizar ítems de factura */
		async function renderInvoiceItems(){
			const container = document.getElementById('invoice-items-list');
			container.innerHTML = '';
			
			const inventory = await loadInventory();

			invoiceItems.forEach((item, index) => {
				const div = document.createElement('div');
				div.className = 'invoice-item-row';
				
				// selector de inventario
				let inventorySelect = '<select data-index="' + index + '" class="item-inventory">';
				inventorySelect += '<option value="">-- Manual --</option>';
				inventory.forEach(inv => {
					const selected = inv.id === item.inventoryItemId ? ' selected' : '';
					const stock = Number(inv.stock || 0);
					const price = inv.unitPrice ? formatCurrency(Number(inv.unitPrice)) : '';
					inventorySelect += `<option value="${inv.id}" data-price="${inv.unitPrice||0}" data-stock="${stock}"${selected}>${escapeHtml(inv.name)} (Stock: ${stock}, ${price})</option>`;
				});
				inventorySelect += '</select>';

				div.innerHTML = `
					${inventorySelect}
					<input type="text" placeholder="Descripción" value="${escapeHtml(item.description||'')}" data-index="${index}" class="item-description">
					<input type="number" placeholder="Cant." min="1" step="1" value="${item.quantity||1}" data-index="${index}" class="item-quantity" style="max-width:80px">
					<input type="number" placeholder="Precio u." min="0" step="0.01" value="${item.unitPrice||0}" data-index="${index}" class="item-price" style="max-width:120px">
					<div class="small" style="max-width:120px">Total: ${formatCurrency(item.total||0)}</div>
					<button type="button" class="btn btn-delete" data-index="${index}" style="padding:6px 10px">✕</button>
				`;
				
				container.appendChild(div);
			});

			// bindings
			$$('.item-inventory').forEach(sel => {
				sel.onchange = (e) => {
					const idx = parseInt(e.target.dataset.index);
					const selectedOpt = e.target.options[e.target.selectedIndex];
					if(selectedOpt.value){
						const invItem = inventory.find(i => i.id === selectedOpt.value);
						if(invItem){
							invoiceItems[idx].inventoryItemId = invItem.id;
							invoiceItems[idx].description = invItem.name;
							invoiceItems[idx].unitPrice = Number(invItem.unitPrice || 0);
							updateItemTotal(idx);
							renderInvoiceItems();
						}
					} else {
						invoiceItems[idx].inventoryItemId = '';
					}
				};
			});

			$$('.item-description').forEach(inp => {
				inp.oninput = (e) => {
					const idx = parseInt(e.target.dataset.index);
					invoiceItems[idx].description = e.target.value;
				};
			});

			$$('.item-quantity').forEach(inp => {
				inp.oninput = (e) => {
					const idx = parseInt(e.target.dataset.index);
					invoiceItems[idx].quantity = Number(e.target.value) || 1;
					updateItemTotal(idx);
					renderInvoiceItems();
				};
			});

			$$('.item-price').forEach(inp => {
				inp.oninput = (e) => {
					const idx = parseInt(e.target.dataset.index);
					invoiceItems[idx].unitPrice = Number(e.target.value) || 0;
					updateItemTotal(idx);
					renderInvoiceItems();
				};
			});

			$$('.invoice-item-row .btn-delete').forEach(btn => {
				btn.onclick = (e) => {
					const idx = parseInt(e.target.dataset.index);
					invoiceItems.splice(idx, 1);
					renderInvoiceItems();
				};
			});

			updateInvoiceTotals();
		}

		/* NUEVO: actualizar total de un ítem */
		function updateItemTotal(index){
			const item = invoiceItems[index];
			item.total = (item.quantity || 0) * (item.unitPrice || 0);
		}

		/* NUEVO: actualizar totales de la factura */
		function updateInvoiceTotals(){
			const subtotal = invoiceItems.reduce((sum, item) => sum + (item.total || 0), 0);
			const tax = subtotal * 0.19; // IVA 19%
			const total = subtotal + tax;

			$('#invoice-subtotal').textContent = formatCurrency(subtotal);
			$('#invoice-tax').textContent = formatCurrency(tax);
			$('#invoice-total').textContent = formatCurrency(total);
		}

		/* NUEVO: guardar factura */
		async function saveInvoiceFromForm(e){
			e.preventDefault();
			const f = e.target;

			if(invoiceItems.length === 0){
				alert('Debes agregar al menos un ítem a la factura');
				return;
			}

			const subtotal = invoiceItems.reduce((sum, item) => sum + (item.total || 0), 0);
			const tax = subtotal * 0.19;
			const total = subtotal + tax;

			const invoices = await loadInvoices();

			if(editingInvoiceId){
				const idx = invoices.findIndex(x=>x.id==editingInvoiceId);
				if(idx>-1){
					invoices[idx] = {
						...invoices[idx],
						clientId: f.clientId.value,
						invoiceNumber: f.invoiceNumber.value,
						date: f.date.value,
						paymentStatus: f.paymentStatus.value,
						notes: f.notes.value,
						items: invoiceItems,
						subtotal,
						tax,
						total,
						updatedAt: new Date().toISOString()
					};
				}
			} else {
				const invoice = {
					id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString().slice(-6),
					clientId: f.clientId.value,
					invoiceNumber: f.invoiceNumber.value,
					date: f.date.value,
					paymentStatus: f.paymentStatus.value,
					notes: f.notes.value,
					items: invoiceItems,
					subtotal,
					tax,
					total,
					createdAt: new Date().toISOString(),
					updatedAt: new Date().toISOString()
				};
				invoices.unshift(invoice);

				// descontar inventario y registrar en finanzas si está pagada
				await processInvoiceInventoryAndFinance(invoice);
			}

			await saveInvoices(invoices);
			closeModal('#modal-invoice');
			await renderInvoices();
			await renderInventory();
			await renderFinance();
		}

		/* NUEVO: exportar factura a PDF */
		async function exportInvoicePDF(id){
			const invoices = await loadInvoices();
			const invoice = invoices.find(i => i.id === id);
			if(!invoice) return alert('Factura no encontrada');

			const clients = await loadClients();
			const client = clients.find(c => c.id === invoice.clientId) || {name:'--', cedula:'', phone:'', email:'', address:''};

			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({unit:'pt', format:'letter'});
			const pageWidth = doc.internal.pageSize.width;
			const margin = 40;
			const centerX = pageWidth / 2;
			let y = 40;

			// Logo
			try {
				const logoImage = await loadImageFromUrl('./image.png');
				const logoSize = 50;
				doc.addImage(logoImage, 'PNG', margin, y, logoSize, logoSize);
			} catch(err) {
				console.error('Error cargando logo:', err);
			}

			// Título y número de factura
			doc.setFontSize(20);
			doc.setFont(undefined, 'bold');
			doc.text('FACTURA', pageWidth - margin - 100, y + 20);
			doc.setFontSize(12);
			doc.setFont(undefined, 'normal');
			doc.text(invoice.invoiceNumber || '', pageWidth - margin - 100, y + 40);

			y += 70;

			// Información de la empresa (izquierda)
			doc.setFontSize(10);
			doc.setFont(undefined, 'bold');
			doc.text('MIPC COMPUTADORES', margin, y);
			y += 15;
			doc.setFont(undefined, 'normal');
			doc.text('NIT: 900.XXX.XXX-X', margin, y);
			y += 12;
			doc.text('Tel: 300 XXX XXXX', margin, y);
			y += 12;
			doc.text('Email: info@mipc.com', margin, y);

			// Información del cliente (derecha)
			y = 110;
			const rightX = centerX + 20;
			doc.setFont(undefined, 'bold');
			doc.text('CLIENTE:', rightX, y);
			y += 15;
			doc.setFont(undefined, 'normal');
			doc.text(client.name, rightX, y);
			y += 12;
			if(client.cedula) { doc.text(`Cédula: ${client.cedula}`, rightX, y); y += 12; }
			if(client.phone) { doc.text(`Tel: ${client.phone}`, rightX, y); y += 12; }
			if(client.email) { doc.text(`Email: ${client.email}`, rightX, y); y += 12; }

			y = Math.max(y, 180) + 20;

			// Fecha
			doc.setFont(undefined, 'bold');
			doc.text(`Fecha: `, margin, y);
			doc.setFont(undefined, 'normal');
			doc.text(invoice.date || '', margin + 50, y);

			y += 30;

			// Línea separadora
			doc.setLineWidth(1);
			doc.line(margin, y, pageWidth - margin, y);
			y += 20;

			// Tabla de ítems
			doc.setFontSize(9);
			doc.setFont(undefined, 'bold');
			
			const colX = [margin, margin + 250, margin + 320, margin + 400, margin + 480];
			doc.text('Descripción', colX[0], y);
			doc.text('Cant.', colX[1], y);
			doc.text('Precio u.', colX[2], y);
			doc.text('Total', colX[3], y);
			
			y += 15;
			doc.setLineWidth(0.5);
			doc.line(margin, y - 5, pageWidth - margin, y - 5);
			
			doc.setFont(undefined, 'normal');
			
			invoice.items.forEach(item => {
				if(y > 700){
					doc.addPage();
					y = 40;
				}
				
				doc.text(item.description || '', colX[0], y, {maxWidth: 240});
				doc.text(String(item.quantity || 0), colX[1], y);
				doc.text(formatCurrency(item.unitPrice || 0), colX[2], y);
				doc.text(formatCurrency(item.total || 0), colX[3], y);
				
				y += 20;
			});

			y += 10;
			doc.line(margin, y, pageWidth - margin, y);
			y += 20;

			// Totales
			const totalsX = pageWidth - margin - 150;
			doc.setFont(undefined, 'normal');
			doc.text('Subtotal:', totalsX, y);
			doc.text(formatCurrency(invoice.subtotal || 0), totalsX + 80, y, {align: 'right'});
			y += 15;
			
			doc.text('IVA (19%):', totalsX, y);
			doc.text(formatCurrency(invoice.tax || 0), totalsX + 80, y, {align: 'right'});
			y += 15;
			
			doc.setFont(undefined, 'bold');
			doc.setFontSize(11);
			doc.text('TOTAL:', totalsX, y);
			doc.text(formatCurrency(invoice.total || 0), totalsX + 80, y, {align: 'right'});

			// Notas
			if(invoice.notes){
				y += 30;
				doc.setFontSize(9);
				doc.setFont(undefined, 'bold');
				doc.text('Notas:', margin, y);
				y += 12;
				doc.setFont(undefined, 'normal');
				const notesLines = doc.splitTextToSize(invoice.notes, pageWidth - margin * 2);
				doc.text(notesLines, margin, y);
			}

			// Footer
			y = 750;
			doc.setFontSize(8);
			doc.setFont(undefined, 'italic');
			const footerText = 'Gracias por su compra - Mipc Computadores';
			const footerWidth = doc.getTextWidth(footerText);
			doc.text(footerText, centerX - footerWidth/2, y);

			doc.save(`factura_${invoice.invoiceNumber}.pdf`);
		}
	</script>
</body>
</html>